<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SK 결합 할인 계산기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS from sk_styles.css */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; /* slate-50 */ }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #334155; /* slate-700 */ }
        .input-field, .select-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; /* slate-300 */ border-radius: 0.375rem; box-shadow: sm; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .input-field:focus, .select-field:focus { border-color: #ef4444; /* red-500 */ outline: none; box-shadow: 0 0 0 0.2rem rgba(239, 68, 68, 0.25); } /* SK Red focus */
        .select-field:disabled, .input-field:disabled { background-color: #e9e9e9; /* Slightly darker gray for disabled */ cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: #ef4444; /* red-500 */ color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #dc2626; /* red-600 */ }
        .btn-primary:disabled { background-color: #f87171; cursor: not-allowed; }
        .btn-secondary { background-color: #f97316; /* orange-500 */ color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #ea580c; /* orange-600 */ }
        .section-title { font-size: 1.5rem; font-weight: 700; color: #c2410c; /* orange-700 */ margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #fb923c /* orange-400 */;}
        .result-card { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
        .result-label { color: #475569; /* slate-600 */ }
        .result-value { color: #1e293b; /* slate-800 */ font-weight: 600;}
        .total-value { color: #ef4444; /* red-500 */ font-size: 1.5rem; font-weight: 700;}
        .mobile-line-item { border: 1px solid #e2e8f0; /* slate-200 */ padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; }
        .radio-label { margin-right: 1rem; margin-bottom: 0.5rem; display: inline-flex; align-items: center; cursor: pointer;}
        .radio-input { margin-right: 0.5rem; accent-color: #ef4444; /* red-500 */ }
        .info-box { background-color: #fff7ed; /* orange-50 */ border-left: 4px solid #f97316; /* orange-500 */ padding: 1rem; margin-top:0.5rem; margin-bottom:1rem; font-size: 0.875rem; color: #9a3412; /* orange-800 */}
        .info-box ul { padding-left: 1.25rem; list-style-type: disc; }
        .info-box ul ul { padding-left: 1rem; list-style-type: circle;}
        .sensitive-info-box { background-color: #fffbeb; /* yellow-50 */ border-left: 4px solid #f59e0b; /* yellow-500 */ padding: 1rem; margin-bottom: 1.5rem; font-size: 0.875rem; color: #b45309; /* yellow-700 */}
        .sensitive-info-box a { color: #0ea5e9; /* sky-500 */ text-decoration: underline;}
        .sensitive-info-box a:hover { color: #0284c7; /* sky-600 */}
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-left: 10px; vertical-align: middle;}
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;}
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: #ef4444; /* red-500 */ }
        input:checked + .slider:before { transform: translateX(20px); }
        .discount-details { background-color: #ffe4e6; border: 1px solid #ffb3b3; padding: 0.75rem; border-radius: 0.375rem; font-size:0.875rem; } /* Light red for SKT */
        .discount-details ul { padding-left: 1.25rem; }
        .discount-details ul ul { padding-left: 1rem; }
        .discount-details h4 { font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: #be123c; } /* Darker red for subheadings */
        .discount-details strong { color: #dc2626; } /* SKT Red for emphasis */
        .summary-item { margin-bottom: 0.25rem; }
        .message-script-area { width: 100%; min-height: 150px; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.875rem; white-space: pre-wrap; word-wrap: break-word; }
        .copy-button-container { text-align: right; margin-top: 0.5rem; }
        .copy-feedback { font-size: 0.75rem; color: green; margin-left: 0.5rem; }
        .cost-qualifier {font-size: 0.875rem; color: #475569; margin-left: 0.25rem;}
        /* AI 로딩 스피너 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-slate-800">
    <header class="bg-red-600 text-white p-6 shadow-md">
        <div class="container mx-auto max-w-4xl">
            <h1 class="text-3xl font-bold text-center">SK 결합 할인 계산기</h1>
            <p class="text-center text-red-200 mt-1">선택하신 서비스와 할인 유형에 따른 예상 요금을 계산해 보세요.</p>
        </div>
    </header>

    <main class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <section id="inputSection" class="mb-8">
            <h2 class="section-title">1. 서비스 선택 (3년 약정 기준, VAT 포함)</h2>
            
            <div class="sensitive-info-box">
                <p class="font-semibold text-yellow-800">⚠️ 민감정보</p>
                <p class="mt-1">
                    <a href="https://miso.kr/booking/forms/secure-details?querystring=고객님 전화번호" target="_blank">https://miso.kr/booking/forms/secure-details?querystring=고객님 전화번호</a>
                </p>
                <p class="mt-1">ㄴ&gt; 위 링크를 고객에게 문자로 전송해주세요. (아래 스크립트 복사 기능 이용)</p>
                <p class="mt-2">
                    참고 스프레드시트: <a href="https://docs.google.com/spreadsheets/d/10d21RrhIPBiJr7RZIHnk0h1dB4GvTEcHCuXSyFYw1M4/edit?gid=0#gid=0" target="_blank">바로가기</a>
                </p>
            </div>

            <div class="input-group">
                <label class="input-label">인터넷 유형 선택</label>
                <div class="flex items-center space-x-4">
                    <label class="radio-label">
                        <input type="radio" name="internetType" value="bundle" class="radio-input" checked> 인터넷 + TV 번들
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="internetType" value="standalone" class="radio-input"> 인터넷 단독
                    </label>
                </div>
            </div>

            <p class="mb-6 text-sm text-slate-600">아래 항목들을 선택하거나 입력해주세요. 모든 요금은 SK브로드밴드/SK텔레콤 표준 3년 약정, 부가세 포함 금액을 기준으로 합니다.</p>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label for="internetPlan" class="input-label">SKB 인터넷 요금제</label>
                    <select id="internetPlan" class="select-field">
                        </select>
                </div>
                
                <div class="input-group">
                    <label for="wifiRouter" class="input-label block mb-1">와이파이 공유기 (선택)</label>
                    <select id="wifiRouter" class="select-field">
                        </select>
                </div>

                <div class="input-group">
                    <label for="tvPlan" class="input-label">B tv 요금제 (1번째 TV)</label>
                    <select id="tvPlan" class="select-field">
                      </select>
                </div>

                <div class="input-group">
                    <label for="tvStb" class="input-label">AI/특수 셋톱박스 추가 (선택)</label>
                    <select id="tvStb" class="select-field">
                        <option value="none" data-price="0">선택 안함 (기본셋톱 사용)</option>
                    </select>
                   <p class="text-xs text-slate-500 mt-1">TV 요금제에 기본 셋톱(예: 스마트3)이 포함되어 있습니다. NUGU, Apple TV 등 AI/특수 셋톱으로 변경 또는 추가 시 선택합니다.</p>
                </div>

                <div class="input-group">
                    <label for="additionalTvPlan" class="input-label">추가 TV 선택 (2번째 TV)</label>
                    <select id="additionalTvPlan" class="select-field">
                      </select>
                </div>
                
                <div class="input-group">
                    <label for="phonePlan" class="input-label">집전화 요금제</label>
                    <select id="phonePlan" class="select-field">
                        </select>
                </div>
            </div>
            
            <div class="input-group mt-6 hidden" id="onGajokYearsGroup">
                <label for="onGajokYears" class="input-label">가족 총 사용 연수 (온가족 할인용)</label>
                <select id="onGajokYears" class="select-field">
                    <option value="0_9">10년 미만</option>
                    <option value="10_19">10년 이상 ~ 20년 미만</option>
                    <option value="20_29">20년 이상 ~ 30년 미만</option>
                    <option value="30_plus">30년 이상</option>
                </select>
            </div>
            <!-- NEW: Internet Usage Period for On-Gajok Discount -->
            <div class="input-group mt-6 hidden" id="internetUsageYearsGroup">
                <label for="internetUsageYears" class="input-label">인터넷 사용 기간 (온가족 할인용)</label>
                <select id="internetUsageYears" class="select-field">
                    <option value="0_1">1년 미만</option>
                    <option value="1_2">1년 이상 ~ 2년 미만</option>
                    <option value="2_3">2년 이상 ~ 3년 미만</option>
                    <option value="3_plus" selected>3년 이상</option>
                </select>
            </div>
        </section>

        <section id="discountTypeSection" class="mb-8">
            <h2 class="section-title">2. 결합 할인 유형 선택</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="mb-4 text-sm text-slate-600">가장 유리한 할인 유형을 선택하거나, 각 유형별 예상 요금을 비교해보세요.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-2">
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="noBundleDiscount" class="radio-input" checked> 결합 할인 없음</label>
                        </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="요즘가족결합" class="radio-input"> 요즘가족결합</label>
                        <label class="toggle-switch"><input type="checkbox" id="yozoomGajokDetailsToggle"><span class="slider"></span></label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="온가족할인" class="radio-input"> 온가족할인</label>
                        <label class="toggle-switch"><input type="checkbox" id="onGajokDetailsToggle"><span class="slider"></span></label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="패밀리결합" class="radio-input"> 패밀리결합</label>
                        <label class="toggle-switch"><input type="checkbox" id="familySktDetailsToggle"><span class="slider"></span></label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                    <div class="flex items-center">
                        <label class="radio-label"><input type="radio" name="discountType" value="알뜰한 결합" class="radio-input"> 알뜰한 결합</label>
                        <label class="toggle-switch"><input type="checkbox" id="mvnoSktDetailsToggle"><span class="slider"></span></label>
                        <span class="ml-1 text-xs text-slate-500">(상세보기)</span>
                    </div>
                </div>
                <div class="input-group mt-6">
                    <label class="input-label">결합 적용 시점 (월 청구요금 표시 방식)</label>
                    <div class="space-y-2">
                        <label class="radio-label">
                            <input type="radio" name="bundleApplicationTime" value="pre" class="radio-input" checked> 선결합 (월 청구액에 할인 즉시 반영)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="bundleApplicationTime" value="post" class="radio-input"> 후결합 (월 청구액에 할인 미반영, 추후 적용)
                        </label>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">후결합 선택 시, 최종 월 납부액은 할인 전 금액으로 표시되며, 실제 적용될 할인액은 별도로 안내됩니다.</p>
                </div>

                <div id="yozoomGajokDetailsContainer" class="mt-3 hidden discount-details">
                    <p class="font-semibold mb-1">요즘가족결합 상세 (상담원 참고용):</p>
                    <p>인터넷 할인: <span id="detailYgInternetDiscount" class="font-bold">0</span>원 <span id="detailYgInternetType" class="text-xs"></span></p>
                    <p>휴대폰 총 할인 (참고용): <span id="detailYgMobileDiscount" class="font-bold">0</span>원</p>
                    <hr class="my-2 border-red-300">
                    <div class="text-xs mt-2 mb-1 text-red-700 font-semibold skt-summary-details">
                        <p class="font-bold">주요 특징:</p><ul><li>인터넷 명의자 본인 모바일 1회선 필수 포함, 최대 5대 가족 모바일 결합.</li><li>명의 다른 가족 모바일 결합 시, 최대 2회선 인터넷 할인 적용 가능.</li></ul>
                        <p class="font-bold mt-2">선결합 조건:</p><ul><li>인터넷 명의자 + 동일 명의 SKT 휴대폰 1대 필수.</li></ul>
                        <p class="font-bold mt-2">최대 결합 가능 회선:</p><ul><li>인터넷 최대 2회선 + 모바일 5회선 (각각 명의자 및 장소 다르게 가능).</li></ul>
                        <p class="font-bold mt-2">인터넷 할인 (JSON 기반):</p><ul id="yozoomGajokInternetDiscountTiers"></ul>
                        <p class="font-bold mt-2">휴대폰 할인 (인터넷 속도 및 회선 수 기반, 참고용 - 기존 로직 유지):</p><ul id="yozoomGajokMobileDiscountTiers"></ul>
                        <p class="font-bold mt-2">동거인 결합 가능:</p><ul><li>결합 대표자 기준 주민등록상 동일 주소 동거인 1인 가족 할인 대상 인정 (예비부부, 동거부부, 친구 등 등본상 동거인).</li></ul>
                        <p class="font-bold mt-2">예시:</p><ul><li>아버지 명의 SK 핸드폰 개통 후 요즘 가족 결합/온가족할인 추가 가능 (모바일 명의 같이 들어와야 함.)</li></ul>
                        <p class="mt-2 text-red-500 font-bold">참고: 모바일 할인액은 선택약정 등 타 할인과 중복 여부 SKT 확인 필요.</p>
                    </div>
                </div>
                <div id="onGajokDetailsContainer" class="mt-3 hidden discount-details">
                    <p class="font-semibold mb-1">온가족할인 상세 (상담원 참고용):</p>
                    <p>인터넷 할인 (예상): <span id="detailOgInternetDiscount" class="font-bold">0</span>원</p>
                    <p>휴대폰 할인 (월정액 기준, 참고용): <span id="detailOgMobileDiscount" class="font-bold">0</span>%</p>
                    <hr class="my-2 border-red-300">
                    <div class="text-xs mt-2 mb-1 text-red-700 font-semibold skt-summary-details">
                        <p class="font-bold">주요 특징:</p><ul><li>가족 구성원의 SKT 총 가입 연수와 인터넷 사용 기간에 따라 할인율 차등 적용.</li></ul>
                        <p class="font-bold mt-2">최대 결합 가능 회선:</p><ul><li>모바일 최대 5회선 + 인터넷 2회선.</li></ul>
                        <p class="font-bold mt-2">회선 추가 조건:</p><ul><li>추가 회선 명의자 휴대폰은 SKT 회선이어야 함.</li></ul>
                        <p class="font-bold mt-2">인터넷 할인 (가족 총 연수 + 인터넷 사용 기간별 %):</p><ul id="onGajokInternetDiscountTiers"></ul>
                        <p class="font-bold mt-2">휴대폰 할인:</p><ul><li>총 가입 연수 20년 이상 시: 대표 모바일 회선 월정액의 10% 할인.</li><li>총 가입 연수 30년 이상 시: 대표 모바일 회선 월정액의 30% 할인.</li><li>(선택약정할인과 중복 가능)</li></ul>
                        <p class="font-bold mt-2">동거인 결합 가능:</p><ul><li>결합 대표자 기준 주민등록상 동일 주소 동거인 1인 가족 할인 대상 인정.</li></ul>
                        <p class="font-bold mt-2">예시:</p><ul><li>아버지 명의 SK 핸드폰 개통 후 요즘 가족 결합/온가족할인 추가 가능 (모바일 명의 같이 들어와야 함.)</li></ul>
                    </div>
                </div>
                <div id="familySktDetailsContainer" class="mt-3 hidden discount-details">
                    <p class="font-semibold mb-1">패밀리결합 상세 (상담원 참고용):</p>
                    <p>자회선 인터넷 할인: <span id="detailFsInternetDiscount" class="font-bold">0</span>원</p>
                    <hr class="my-2 border-red-300">
                    <div class="text-xs mt-2 mb-1 text-red-700 font-semibold skt-summary-details">
                        <p class="font-bold">주요 특징:</p><ul><li>본인 또는 직계가족의 SKT/SKB 인터넷(모회선)이 다른 장소에 있을 경우, 신규 추가 인터넷(자회선) 할인.</li><li>SKT는 SKT끼리, SKB는 SKB끼리 결합.</li></ul>
                        <p class="font-bold mt-2">조건:</p><ul><li>본인 또는 직계가족 명의로 다른 장소에 SK 인터넷 회선이 있어야 함.</li></ul>
                        <p class="font-bold mt-2">회선 구성:</p><ul><li>모회선 1회선 + 자회선 1회선.</li></ul>
                        <p class="font-bold mt-2">할인액 (JSON 기반, 자회선 기준):</p><ul id="familyInternetDiscountTiers"></ul>
                        <p class="font-bold mt-2">예시:</p><ul><li>아버지 명의 SK 인터넷 추가 하고 싶어함 --&gt; 요즘 가족 결합 또는 온가족 할인 불가 , 패밀리 결합 진행</li></ul>
                        <p class="font-bold mt-2">유의사항:</p><ul><li>모회선 1년 유지 필수, 미유지 시 할인액 반환.</li><li>10개월 이내 해지 시 사은품 환수 가능.</li></ul>
                        <p class="font-bold mt-2">결합 방법:</p><ul><li>SKT: 본인 신분증, 모회선 가족관계증명서, 모회선 정보로 선결합 가능.</li><li>SKB 본인 패밀리: SKT와 동일, 선결합 가능.</li><li>SKB 타인 패밀리: 본사를 통한 후결합만 가능.</li></ul>
                    </div>
                </div>
                <div id="mvnoSktDetailsContainer" class="mt-3 hidden discount-details">
                    <p class="font-semibold mb-1">알뜰한 결합 상세 (상담원 참고용):</p>
                    <p>인터넷 할인: <span id="detailMsInternetDiscount" class="font-bold">0</span>원</p>
                    <hr class="my-2 border-red-300">
                    <div class="text-xs mt-2 mb-1 text-red-700 font-semibold skt-summary-details">
                        <p class="font-bold">주요 특징:</p><ul><li>SKB 인터넷 + 본인 명의 알뜰폰 1:1 결합 (SKB만 가능).</li></ul>
                        <p class="font-bold mt-2">대상:</p><ul><li>30일 이내 SKB 신규 가입 고객 또는 SKB 약정 종료 고객.</li></ul>
                        <p class="font-bold mt-2">할인액 (JSON 기반, 인터넷 속도별):</p><ul id="mvnoInternetDiscountTiers"></ul>
                        <p class="font-bold mt-2">결합 불가:</p><ul><li>SKT 및 법인 회선.</li><li>선불폰, IOT 요금제, 데이터 쉐어링, 태블릿 등 미협의 요금제.</li><li>알뜰폰 통신사 변경 시 재결합 불가.</li></ul>
                        <p class="font-bold mt-2">결합 가능 알뜰폰 사업자 (예시):</p><ul><li>KB 국민은행(리브엠모바일), 큰사람커넥트(이야기모바일), 유니컴즈(모빙), 토스, 아이즈비전, SK텔링크(세븐모바일), 티플러스(KTC), 스마텔 등 (전체 목록 SKB 확인).</li></ul>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-8">
            <div class="input-group">
                <label class="input-label">모바일 회선 정보 (최대 5회선)</label>
                <div class="flex items-center mb-2">
                    <label for="mobileLinesCount" class="mr-2 text-sm text-slate-700">결합할 SKT 모바일 회선 수:</label>
                    <input type="number" id="mobileLinesCount" min="0" max="5" value="0" class="input-field w-20 text-center">
                </div>
                <div id="mobileLinesContainer" class="space-y-3"></div>
            </div>
             <div class="input-group">
                <label for="dongpanSalesCheck" class="input-label flex items-center cursor-pointer">
                    <input type="checkbox" id="dongpanSalesCheck" class="radio-input h-5 w-5 mr-2">
                    동판 판매가 적용 (선택 시 추가 사은품 조건 및 관련 안내 보기)
                </label>
            </div>
            <div id="dongpanUsimPolicyDetailsContainer" class="mt-3 hidden discount-details">
                <h3 class="text-lg font-bold text-red-700 mb-2">SKT 인터넷/유심 결합 상품 접수 방법 (동판유심 참고자료)</h3>
                <p class="text-xs mb-1"><strong>신청서 URL:</strong> <a href="https://tgateplus.sktelecom.com/main/main.do?p=9d7d8b5b0b339b80214797b42ff596a914f9d2a8103175f5b4e3a208ea7e3cab" target="_blank" class="text-blue-600 hover:underline">T게이트플러스 신청 바로가기</a></p>
                <p class="text-xs mb-3">작성일: 2023년 10월 27일 기준 (최신 정책은 SKT 공식 채널을 통해 확인하시기 바랍니다)</p>
                <h4>결합 상품 구성 및 가능 회선:</h4>
                <ul><li>SKT 인터넷과 유심을 결합하는 상품입니다.</li><li>가족 유심 결합 시, 총 5회선(인터넷 1회선 + 유심 동반 명의자 1회선 + 가족 유심 최대 4회선)까지 가능합니다. <strong>⚠️ 인+유심동판+가족유심4회선 까지 총 5회선까지 가능</strong></li></ul>
                <h4>단독 상품 판매 불가 정책:</h4>
                <ul><li>인터넷 단독으로는 33,000원 요금제 판매 및 가족 유심 판매가 불가합니다. <strong>⚠️ 인단독 > 33K 판매 불가/가족 유심 판매 불가</strong></li><li>번들(결합) 상품의 경우, 모든 요금제와 가족 유심 판매가 가능합니다. <strong>⚠️ 번들> 모든 요금제 + 가족 유심 판매 가능</strong></li></ul>
                <h4>접수 절차:</h4><ol class="list-decimal list-inside space-y-1"><li>위 신청서 링크로 인증(PASS or 신용카드) 후 신청서 작성.</li><li>백메가 접수웹(speedonline.kr)의 SK(일반) ⇒ 모바일 탭으로 접수 부탁 드립니다.</li><li>웹 회신:<ul class="list-disc list-inside ml-4"><li>해당 고객 인터넷 개통이 완료되면: "[개통 완료 / 유심 발송 요청]"으로 웹 회신 필요.</li><li>※ 이미 개통된 고객 30일 이내 유심동판 시: "[개통완료 일자, 개통번호 기재 / 유심 발송 요청]"으로 웹 회신 필요.</li><li>고객이 유심 수령하신 후 미소로 개통 요청 시: "[고객 유심 수령 완료 / 개통 진행 요청]" 필요.</li></ul></li><li>사전 동의 문자 처리:<ul class="list-disc list-inside ml-4"><li>※ 개통 요청하면 [사전동의문자:위약금 확인 및 동의문자]가 고객에게 발송되며, 해당 문자 처리 후 개통 진행 가능.</li><li>※ 동의 처리하지 않을 시 문자 발송 후 10분 전산에서 강제로 동의처리 후 개통진행 가능.</li></ul></li><li>수령한 USIM으로 갈아끼우시고 전원 ON에 성공하시면 선택약정과 유무선 결합 진행 필수.</li><li>※ 선약 및 결합 완료시 [개통완료]로 처리됨.</li></ol>
                <h4>고객 안내 사항:</h4><ol class="list-decimal list-inside space-y-1"><li>유심 개통은 순차적으로 진행되어 최대 1시간 까지 소요될 수 있습니다.</li><li>사전 동의 문자 처리가 완료되어야 빠른 개통 처리가 가능합니다.</li><li>SK USIM 으로 개통되기 전까지는 기존 USIM을 사용하시다가 기존 USIM의 신호가 끊어질 경우 수령하신 USIM으로 갈아 끼워주세요.</li><li>기기 재시동을 여러번 해주시면 정상 개통이 완료됩니다.</li></ol>
                <h4>주의 사항 (수수료 지급 관련):</h4><ol class="list-decimal list-inside space-y-1"><li>유심 당일 발송은 15시 30분에 마감됩니다. 이후 요청건 영업일 기준 익일 진행됩니다.</li><li>유심 비용 7,700원이 첫 달에 청구됩니다.</li><li>인터넷 / 유심 중 하나라도 설불 및 개통 불가시 수수료 지급 불가합니다.</li><li>인터넷 개통월 기준 익월말까지 유심 개통시에만 수수료 인정되어 지급됩니다.</li><li>선택약정 적용 안될 경우 수수료 지급 불가합니다.</li><li>인터넷 명의자와 유심 명의자가 상이할 경우 수수료 지급 불가합니다.</li></ol>
                <p class="mt-2"><strong>결론:</strong> SKT 인터넷/유심 결합 상품은 가족 유심 결합 시 최대 5회선까지 가능하며, 단독 상품 판매에 제약이 있습니다. 접수는 온라인 신청서 작성 및 웹 접수를 통해 진행되며, 고객의 사전 동의 문자 처리와 유심 교체 및 개통 과정이 필수적입니다. 특히, 수수료 지급과 관련하여 유심 개통 기간, 선택약정 적용, 명의자 일치 여부 등 여러 유의사항이 있으므로 해당 내용을 숙지하고 접수 및 개통을 진행해야 합니다.</p>
            </div>
        </section>

        <section id="installationSection" class="mb-8">
            <h2 class="section-title">3. 설치 옵션</h2>
            <div class="input-group bg-white p-6 rounded-lg shadow">
                <label class="input-label">설치비</label>
                <div class="space-y-2">
                    <label class="radio-label"><input type="radio" name="installationTime" value="promo_waiver" class="radio-input"> 설치비 면제 프로모션</label>
                    <label class="radio-label"><input type="radio" name="installationTime" value="weekday" class="radio-input" checked> 평일 주간</label>
                    <label class="radio-label"><input type="radio" name="installationTime" value="weekend" class="radio-input"> 주말/야간</label>
                </div>
            </div>
        </section>

        <!-- 신규: 제휴카드 할인 섹션 -->
        <section id="affiliateCardSection" class="mb-8">
            <h2 class="section-title">4. 제휴카드 추가 할인 (선택)</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label for="affiliateCardSelect" class="input-label">제휴카드 선택</label>
                        <select id="affiliateCardSelect" class="select-field">
                            <option value="none">선택 안함</option>
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div class="input-group hidden" id="cardTierGroup">
                        <label for="cardTierSelect" class="input-label">전월 실적 구간 선택</label>
                        <select id="cardTierSelect" class="select-field">
                            <!-- Tiers will be populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="info-box mt-4">
                    <p class="font-semibold">참고</p>
                    <ul class="list-disc pl-5 mt-1 text-sm">
                        <li>할인액은 전월 실적에 따라 달라지며, 카드사에 직접 확인이 필요합니다.</li>
                        <li>자세한 내용은 카드사 문의 (롯데: 1588-8100, 현대: 1577-6000, 삼성: 1588-8700, KB: 1588-1688, 하나: 1800-1111)</li>
                    </ul>
                </div>
            </div>
        </section>


        <div class="text-center mb-8 space-x-4">
            <button id="calculateButton" class="btn-primary text-lg">예상 요금 계산하기</button>
            <button id="resetButton" class="btn-secondary text-lg">초기화</button>
        </div>

        <section id="resultSection" class="hidden">
            <h2 class="section-title">📊 계산 결과</h2>
            
            <div class="bg-slate-50 p-6 rounded-lg mb-6 border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4 text-center">✅ 최종 요금 및 혜택 요약</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-white rounded-md shadow-sm">
                        <p class="text-base font-medium text-slate-600">🖥️ 인터넷/TV 월 최종 요금</p>
                        <p id="summaryMonthlyCost" class="text-3xl font-extrabold text-red-500 my-1">0원</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-md shadow-sm">
                        <p class="text-base font-medium text-green-800">🎁 총 사은품 혜택</p>
                        <p id="summaryTotalGift" class="text-3xl font-extrabold text-green-600 my-1">0원</p>
                    </div>
                </div>
                <hr class="my-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-sm text-slate-500">인터넷 요금 할인</p>
                        <p id="summaryInternetDiscount" class="text-lg font-bold text-green-600">- 0원</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-slate-500">휴대폰 요금 할인 (월)</p>
                        <p id="summaryMobileDiscount" class="text-lg font-bold text-green-600">- 0원</p>
                        <p class="text-xs text-slate-400">(통신비 청구서에서 별도 차감)</p>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-6">
               <button id="toggleDetailsButton" class="text-sm text-slate-500 hover:text-slate-700 bg-slate-100 hover:bg-slate-200 py-2 px-4 rounded-full transition-colors">
                상세 요금 내역 펼쳐보기 ▼
                </button>
            </div>

            <div id="detailsContainer" class="hidden">
                <div class="result-card">
                    <h3 class="text-xl font-semibold text-orange-600 mb-3">선택 상품 상세</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="result-label summary-item">선택 인터넷: <span id="selectedInternet" class="result-value"></span></p>
                            <p class="result-label summary-item">선택 TV (1번째): <span id="selectedTv" class="result-value"></span></p>
                            <p class="result-label summary-item">선택 추가 AI/특수 셋톱 (1번째 TV): <span id="selectedStb" class="result-value"></span></p>
                            <p class="result-label summary-item">선택 추가 TV (2번째): <span id="selectedAdditionalTv" class="result-value"></span></p>
                            <p class="result-label summary-item">선택 집전화: <span id="selectedPhone" class="result-value"></span></p>
                            <p class="result-label summary-item">선택 와이파이: <span id="selectedWifi" class="result-value"></span></p>
                        </div>
                        <div>
                             <p class="result-label summary-item">모바일 회선 수: <span id="selectedMobileCount" class="result-value"></span></p>
                             <p class="result-label summary-item">적용 할인 유형: <span id="selectedDiscountType" class="result-value"></span></p>
                             <div id="onGajokYearsResultContainer" class="hidden result-label summary-item">
                                 온가족 총 사용 연수: <span id="selectedOnGajokYears" class="result-value"></span>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <h3 class="text-xl font-semibold text-orange-600 mb-3">인터넷/TV 요금 계산 과정</h3>
                    <p class="result-label summary-item">월 인터넷 기본료 (단독/TV결합 기준): <span id="totalBaseInternetCost" class="result-value">0</span> 원</p>
                    <p class="result-label summary-item">월 와이파이 공유기 임대료: <span id="wifiRouterRentalCostDisplay" class="result-value">0</span> 원</p>
                    <div id="tvCostSummaryContainer" class="hidden"> 
                        <p class="result-label summary-item">월 TV 요금 (1번째, 기본셋톱 포함): <span id="tvBaseCostDisplay" class="result-value">0</span> 원</p>
                        <p class="result-label summary-item">월 추가 AI/특수 셋톱 임대료 (1번째): <span id="stbRentalCostDisplay" class="result-value">0</span> 원</p>
                    </div>
                    <div id="additionalTvCostSummaryContainer" class="hidden">
                        <p class="result-label summary-item">월 추가 TV 요금 (2번째): <span id="additionalTvCostDisplay" class="result-value">0</span> 원</p>
                    </div>
                    <div id="phoneCostSummaryContainer" class="hidden">
                        <p class="result-label summary-item">월 집전화 기본료: <span id="phoneBaseCostDisplay" class="result-value">0</span> 원</p>
                    </div>
                    <hr class="my-2 border-slate-200">
                    <p class="result-label text-green-600 summary-item">월 총 인터넷 결합 할인액 (예상): <span id="totalInternetDiscountAmount" class="result-value text-green-600">0</span> 원</p>
                    <p class="text-xs text-slate-500 ml-2 mb-2" id="internetDiscountBreakdown"></p>
                    <!-- 신규: 제휴카드 할인 내역 -->
                    <div id="cardDiscountSummaryContainer" class="hidden">
                        <p class="result-label text-green-600 summary-item">월 제휴카드 추가 할인: <span id="totalCardDiscountAmount" class="result-value text-green-600">0</span> 원</p>
                        <p class="text-xs text-slate-500 ml-2 mb-2" id="cardDiscountBreakdown"></p>
                    </div>

                    <hr class="my-2 border-red-300">
                    <p class="mt-2 text-lg font-semibold">
                        <span id="finalCostLabelText">최종 예상 월 납부액</span><span id="finalCostLabelQualifier" class="cost-qualifier"></span>: <span id="finalMonthlyCost" class="total-value">0</span> 원
                    </p>
                </div>

                <div class="result-card">
                    <h3 class="text-xl font-semibold text-orange-600 mb-3">🎁 사은품 혜택 상세</h3>
                    <p class="result-label summary-item">기본 인터넷 사은품 (예상): <span id="giftBaseInternet" class="result-value">0</span> 원</p>
                    <p class="result-label summary-item hidden" id="additionalDongpanCashContainer">동판 추가 현금 사은품 (모바일 요금제 연동 합계): <span id="giftAdditionalDongpanCash" class="result-value">0</span> 원</p>
                    <hr class="my-1">
                    <p class="result-label summary-item font-semibold">총 사은품 가치 (예상): <span id="giftTotal" class="result-value text-green-600">0</span> 원</p>
                    <p class="text-xs text-red-500 mt-1" id="giftEligibilityNote"></p>
                </div>
                
                <div id="mobileDiscountDetailsContainer" class="result-card hidden">
                    <h3 class="text-xl font-semibold text-orange-600 mb-3">📱 모바일 요금 할인 상세</h3>
                    <div id="mobileDiscountBreakdown" class="space-y-2 text-sm">
                    </div>
                    <p id="mobileDiscountNote" class="text-xs text-slate-500 mt-2"></p>
                </div>

                <div class="result-card">
                    <h3 class="text-xl font-semibold text-orange-600 mb-3">초기 설치 비용</h3>
                    <p class="result-label">예상 총 설치비: <span id="installationCostResult" class="result-value text-lg">0</span> 원</p>
                    <p class="text-xs text-slate-500 mt-1" id="installationCostDescription"></p>
                </div>
            </div>
        </section>
        
        <section id="messageScriptSection" class="hidden mt-12">
    <h2 class="section-title">📄 고객 안내 문자 스크립트 (상담원 참고용)</h2>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">1. 전산 메모</h3>
        <textarea id="memoScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container"><button onclick="copyToClipboard('memoScript', 'copyFeedbackMemo')" class="btn-secondary text-xs">복사하기</button><span id="copyFeedbackMemo" class="copy-feedback"></span></div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">2. 상품 안내 문자</h3>
        <div class="mb-3 text-right">
            <button id="generateComparisonButton" class="btn-secondary text-xs py-1 px-3">⚡ 100M vs 500M 비교 스크립트 생성</button>
        </div>
        <textarea id="infoScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container"><button onclick="copyToClipboard('infoScript', 'copyFeedbackInfo')" class="btn-secondary text-xs">복사하기</button><span id="copyFeedbackInfo" class="copy-feedback"></span></div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">3. 가입 완료 문자</h3>
        <textarea id="completeScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container"><button onclick="copyToClipboard('completeScript', 'copyFeedbackComplete')" class="btn-secondary text-xs">복사하기</button><span id="copyFeedbackComplete" class="copy-feedback"></span></div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">4. 유심 접수 완료 안내 (고객용)</h3>
        <textarea id="usimDongpanCompleteScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container"><button onclick="copyToClipboard('usimDongpanCompleteScript', 'copyFeedbackUsimComplete')" class="btn-secondary text-xs">복사하기</button><span id="copyFeedbackUsimComplete" class="copy-feedback"></span></div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">5. 민감정보 전송용 링크 (고객 발송용)</h3>
        <textarea id="sensitiveInfoLinkScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container">
            <button onclick="copyToClipboard('sensitiveInfoLinkScript', 'copyFeedbackSensitiveInfo')" class="btn-secondary text-xs">복사하기</button>
            <span id="copyFeedbackSensitiveInfo" class="copy-feedback"></span>
        </div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">6. 1년 vs 3년 약정 최종 비용(TCO) 비교</h3>
        <div class="flex space-x-2 mb-4">
            <button id="generateTco100MbpsButton" class="w-full text-white font-semibold py-2 px-4 rounded-lg bg-pink-500 hover:bg-pink-600 transition-colors">100Mbps 비교 스크립트 생성</button>
            <button id="generateTco500MbpsButton" class="w-full text-white font-semibold py-2 px-4 rounded-lg bg-slate-500 hover:bg-slate-600 transition-colors">500Mbps 비교 스크립트 생성</button>
        </div>
        <textarea id="tcoComparisonResultScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container">
            <button onclick="copyToClipboard('tcoComparisonResultScript', 'copyFeedbackTco')" class="btn-secondary text-xs">복사하기</button>
            <span id="copyFeedbackTco" class="copy-feedback"></span>
        </div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">7. SK 위약금 산정 방식 상세 분석</h3>
        <textarea id="penaltyAnalysisScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container">
            <button onclick="copyToClipboard('penaltyAnalysisScript', 'copyFeedbackPenalty')" class="btn-secondary text-xs">복사하기</button>
            <span id="copyFeedbackPenalty" class="copy-feedback"></span>
        </div>
    </div>
    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">8. 위약금 면제 조건 총정리</h3>
        <textarea id="waiverInfoScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container">
            <button onclick="copyToClipboard('waiverInfoScript', 'copyFeedbackWaiver')" class="btn-secondary text-xs">복사하기</button>
            <span id="copyFeedbackWaiver" class="copy-feedback"></span>
        </div>
    </div>

    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3 border-t pt-4 mt-4">9. 상담 내용으로 AI 설득 문자 생성</h3>
        <p class="text-sm text-slate-600 mb-3">아래에 고객과의 상담 내용을 입력하고, '고급 설정'을 조절하여 상황에 맞는 최적의 설득 문자를 생성해 보세요.</p>
        
        <textarea id="aiConsultationInput" class="message-script-area" rows="8" placeholder="이곳에 '생각해볼게요'라고 말한 고객과의 상담 내용을 붙여넣으세요... (고객의 불편함, 원하는 점, 망설이는 이유 등이 잘 나타날수록 좋습니다.)"></textarea>
        
        <details class="mt-4 mb-4">
            <summary class="cursor-pointer text-slate-600 hover:text-slate-800 font-semibold">
                🤖 AI 고급 설정 펼쳐보기 ▼
            </summary>
            <div class="mt-3 p-4 border rounded-md bg-slate-50 grid md:grid-cols-2 gap-4">
                <div class="input-group !mb-0">
                    <label for="aiRoleInput" class="input-label">역할 (Persona)</label>
                    <input type="text" id="aiRoleInput" class="input-field" value="15년 경력의 통신비 절약 컨설턴트">
                </div>
                <div class="input-group !mb-0">
                    <label for="aiToneSelect" class="input-label">어조 (Tone)</label>
                    <select id="aiToneSelect" class="select-field">
                        <option value="따뜻하고 공감적인">따뜻하고 공감적인</option>
                        <option value="전문적이고 신뢰감 있는" selected>전문적이고 신뢰감 있는</option>
                        <option value="활기차고 친근한">활기차고 친근한</option>
                    </select>
                </div>
                <div class="input-group !mb-0">
                    <label for="aiAudienceInput" class="input-label">대상 고객 특징 (Audience)</label>
                    <input type="text" id="aiAudienceInput" class="input-field" placeholder="예: 가격에 민감한 20대 학생">
                </div>
                <div class="input-group !mb-0">
                    <label for="aiEmotionInput" class="input-label">공략할 감정/가치 (Emotion)</label>
                    <input type="text" id="aiEmotionInput" class="input-field" placeholder="예: 잦은 끊김으로 인한 답답함">
                </div>
                <div class="input-group !mb-0 md:col-span-2">
                    <label for="aiStructureSelect" class="input-label">설득 구조 (Structure)</label>
                    <select id="aiStructureSelect" class="select-field">
                        <option value="문제 제기 -> 원인 분석 -> 해결 방안 제시">문제 제기 → 원인 분석 → 해결 방안 제시</option>
                        <option value="공감 -> 핵심 혜택 강조 -> 결정 촉구" selected>공감 → 핵심 혜택 강조 → 결정 촉구</option>
                    </select>
                </div>
            </div>
        </details>

        <div class="text-center mt-4">
            <button id="generateAiScriptButton" class="btn-primary text-lg">
                🤖 AI 설득 문자 생성하기
            </button>
        </div>
    </div>

    <div class="result-card">
        <h3 class="text-xl font-semibold text-orange-600 mb-3">AI 추천 설득 스크립트</h3>
        <div id="aiLoadingIndicator" class="hidden text-center">
            <div class="loader"></div>
            <p class="text-slate-600">AI가 고객님의 마음을 얻을 설득 스크립트를 작성하고 있습니다...</p>
        </div>
        <textarea id="aiResultScript" class="message-script-area" readonly></textarea>
        <div class="copy-button-container">
            <button onclick="copyToClipboard('aiResultScript', 'copyFeedbackAiScript')" class="btn-secondary text-xs">복사하기</button>
            <span id="copyFeedbackAiScript" class="copy-feedback"></span>
        </div>
    </div>
    </section>

        

    </main>

    <footer class="text-center p-6 mt-12 bg-red-700 text-red-100 text-sm">
        <p>본 계산기는 SKB/SKT 미소에서 제공합니다.</p>
        <p>&copy; 2024 SK 결합 할인 계산기. 모든 정보는 참고용입니다.</p>
    </footer>

    <script>
    // --- (신규 추가) 모바일 요금제 데이터 ---
    const mobilePlanTiers = {
        "80K": [ { "plan_name": "5GX 프라임플러스", "network_type": "5G", "price": "₩99,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00007622" }, { "plan_name": "5GX 프라임", "network_type": "5G", "price": "₩89,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006404" }, { "plan_name": "0 청년 99 (만 34세 이하)", "network_type": "5G", "price": "₩99,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00008139" }, { "plan_name": "0 청년 89 (만 34세 이하)", "network_type": "5G", "price": "₩89,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00008140" }, { "plan_name": "T플랜 맥스", "network_type": "LTE", "price": "₩100,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006539" }, { "plan_name": "T플랜 스페셜", "network_type": "LTE", "price": "₩79,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00007301" } ],
        "69K": [ { "plan_name": "5GX 레귤러", "network_type": "5G", "price": "₩69,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006538" }, { "plan_name": "5GX 레귤러플러스", "network_type": "5G", "price": "₩79,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00008141" }, { "plan_name": "0 청년 79 (만 34세 이하)", "network_type": "5G", "price": "₩79,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00008142" }, { "plan_name": "0 청년 69 (만 34세 이하)", "network_type": "5G", "price": "₩69,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006537" }, { "plan_name": "T플랜 에센스", "network_type": "LTE", "price": "₩69,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00007620" } ],
        "33K": [ { "plan_name": "베이직", "network_type": "5G", "price": "₩49,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00007621" }, { "plan_name": "베이직플러스", "network_type": "5G", "price": "₩59,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006402" }, { "plan_name": "슬림", "network_type": "5G", "price": "₩55,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00008145" }, { "plan_name": "0청년 59 (만 34세 이하)", "network_type": "5G", "price": "₩59,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00008145" }, { "plan_name": "0청년 49 (만 34세 이하)", "network_type": "5G", "price": "₩49,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006817" }, { "plan_name": "0틴 5G (만 18세 이하)", "network_type": "5GX", "price": "₩45,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006536" }, { "plan_name": "T플랜 안심 4G", "network_type": "LTE", "price": "₩50,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006535" }, { "plan_name": "T플랜 안심 2.5G", "network_type": "LTE", "price": "₩43,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006534" }, { "plan_name": "T플랜세이브", "network_type": "LTE", "price": "₩33,000", "url": "https://m.tworld.co.kr/product/callplan?prod_id=NA00006534" } ]
    };
    let allMobilePlans = [];
    
    // --- New Affiliate Card Data ---
    const affiliateCards = {
        "skt": [
            { id: "skt_lotte_tello_se", name: "롯데 TELLO SE", tiers: [ { spend: 400000, discount: 8000, label: "40만↑/월 8,000원 할인" }, { spend: 800000, discount: 13000, label: "80만↑/월 13,000원 할인" } ] },
            { id: "skt_hyundai_m_ed3", name: "현대카드M Ed3", tiers: [ { spend: 500000, discount: 15000, label: "50만↑/월 15,000원 할인" }, { spend: 1000000, discount: 25000, label: "100만↑/월 25,000원 할인" } ] },
            { id: "skt_samsung_t", name: "T나는혜택 삼성", tiers: [ { spend: 300000, discount: 7000, label: "30만↑/월 7,000원 할인" }, { spend: 700000, discount: 13000, label: "70만↑/월 13,000원 할인" } ] },
            { id: "skt_kb_t_premium", name: "T-Premium KB", tiers: [ { spend: 400000, discount: 15000, label: "40만↑/월 15,000원 할인 (통신비 5.5만 이상)" } ] }
        ],
        "skb": [
            { id: "skb_hyundai_m_ed2", name: "현대카드M Ed2", tiers: [ { spend: 400000, discount: 15000, label: "40만↑/월 15,000원 할인" }, { spend: 800000, discount: 20000, label: "80만↑/월 20,000원 할인" } ] },
            { id: "skb_lotte_b", name: "B롯데카드", tiers: [ { spend: 300000, discount: 11000, label: "30만↑/월 11,000원 할인" }, { spend: 500000, discount: 13000, label: "50만↑/월 13,000원 할인" }, { spend: 1000000, discount: 20000, label: "100만↑/월 20,000원 할인" } ] },
            { id: "skb_samsung", name: "삼성카드", tiers: [ { spend: 300000, discount: 10000, label: "30만↑/월 7천~1만 할인" }, { spend: 700000, discount: 13000, label: "70만↑/월 1만~1.3만 할인" }, { spend: 1200000, discount: 16000, label: "120만↑/월 1.3만~1.6만 할인" } ] },
            { id: "skb_hana_the_simple", name: "더 심플 하나", tiers: [ { spend: 300000, discount: 10000, label: "30만↑/월 10,000원 할인" }, { spend: 800000, discount: 15000, label: "80만↑/월 15,000원 할인" } ] },
        ]
    };


    // --- New JSON Data Structure ---
    const jsonData = {
        "internetPlans_base": [{"id": "internet_100m_standalone","name": "100M 인터넷 (단독)","price": 22000,"speed_mbps": 100,"note": "단독 기본료"}, {"id": "internet_500m_standalone","name": "500M 인터넷 (단독)","price": 33000,"speed_mbps": 500,"note": "단독 기본료"}, {"id": "internet_1g_standalone","name": "1GB 인터넷 (단독)","price": 38500,"speed_mbps": 1000,"note": "단독 기본료"}],
        "internetPlans_tv_bundle_prices": [{"id": "internet_100m_with_tv","name": "100M 인터넷 (TV 결합 시)","price": 19800,"speed_mbps": 100,"note": "TV 결합 시 인터넷 최종가 추정"}, {"id": "internet_500m_with_tv","name": "500M 인터넷 (TV 결합 시)","price": 27500,"speed_mbps": 500,"note": "TV 결합 시 인터넷 최종가 추정"}, {"id": "internet_1g_with_tv","name": "1GB 인터넷 (TV 결합 시)","price": 33000,"speed_mbps": 1000,"note": "TV 결합 시 인터넷 최종가 추정"}],
        "tvPackages": [{"id": "tv_economy_smart3","name": "B tv 이코노미 (183채널) + 스마트3","price": 14300,"channels": 183,"stb": "스마트3"}, {"id": "tv_standard_smart3","name": "B tv 스탠다드 (234채널) + 스마트3","price": 17600,"channels": 234,"stb": "스마트3"}, {"id": "tv_all_smart3","name": "B tv ALL (257채널) + 스마트3","price": 20900,"channels": 257,"stb": "스마트3"}, {"id": "tv_standard_netflix_2p","name": "B tv 스탠다드 넷플릭스 (2인/1080p)","price": 29900,"note": "동시시청 2인/해상도 1080p","base_tv_plan": "스탠다드","netflix_tier": "스탠다드"}, {"id": "tv_standard_netflix_premium_4p","name": "B tv 스탠다드 넷플릭스 프리미엄 (4인/4K+HDR)","price": 32900,"note": "동시시청 4인/해상도 4K+HDR","base_tv_plan": "스탠다드","netflix_tier": "프리미엄"}, {"id": "tv_all_netflix_2p","name": "B tv ALL 넷플릭스 (2인/1080p)","price": 32400,"note": "동시시청 2인/해상도 1080p","base_tv_plan": "ALL","netflix_tier": "스탠다드"}, {"id": "tv_all_netflix_premium_4p","name": "B tv ALL 넷플릭스 프리미엄 (4인/4K+HDR)","price": 35400,"note": "동시시청 4인/해상도 4K+HDR","base_tv_plan": "ALL","netflix_tier": "프리미엄"}],
        "additionalTvPackages": [{"id": "addtv_economy_smart3","name": "추가TV 이코노미 (183채널) + 스마트3","price": 8250}, {"id": "addtv_economy_apple","name": "추가TV 이코노미 (애플셋탑)","price": 8250}, {"id": "addtv_standard_smart3","name": "추가TV 스탠다드 (234채널) + 스마트3","price": 9900}, {"id": "addtv_standard_apple","name": "추가TV 스탠다드 (애플셋탑)","price": 9900}, {"id": "addtv_all_smart3","name": "추가TV ALL (257채널) + 스마트3","price": 11550}, {"id": "addtv_all_apple","name": "추가TV ALL (애플셋탑)","price": 11550}],
        "phonePlans": [
            {"id": "phone_landline_new", "name": "일반 전화", "price": 1100},
            {"id": "phone_070_basic_new", "name": "070 전화 (인터넷+전화 기본 요금제 / 단말기 대여 X)", "price": 1100},
            {"id": "phone_070_free_internet_new", "name": "070 전화 (인터넷+집전화 프리 요금제 / 단말기 대여 X)", "price": 4400},
            {"id": "phone_070_free_internet_tv_new", "name": "070 전화 (인터넷+TV+집전화 프리 요금제 / 단말기 대여 X)", "price": 2200}
        ],
        "addOnServices": [
            {"id": "wifi_router_default","name": "와이파이 공유기","price": 1100, "url": ""}, 
            {"id": "wifi_router_yozoom_100M_tv","name": "요즘우리집결합(인+티 100Mb) 시 공유기","price": 2200,"condition": "요즘우리집결합 인+티 100Mb", "url": ""}, 
            {"id": "wifi_router_not_selected","name": "공유기 선택 안함(X)","price": 0, "url": ""},
            {"id": "wings_amplifier", "name": "WINGS (증폭기)", "price": 1650, "type": "STB"},
            {"id": "nugu2_stb", "name": "Nugu2 (AI 셋톱박스)", "price": 2200, "type": "AI STB"},
            {"id": "ai_soundbar_max_stb", "name": "AI 사운드바 맥스", "price": 6600, "type": "AI STB"},
            {"id": "apple_tv_stb_promo", "name": "애플셋탑 (프로모션 진행 중)", "price": 0, "type": "STB", "note": "프로모션 확인 필요"},
            {"id": "ai4_vision_stb", "name": "AI4 Vision", "price": 8800, "type": "STB"}
        ],
        "bundleInternetDiscounts": [{"bundle_name": "요즘가족결합","condition": "100M + TV","discount_amount": 3300}, {"bundle_name": "패밀리결합","condition": "100M + TV","discount_amount": 3300}, {"bundle_name": "알뜰한 결합","condition": "100M + TV","discount_amount": 3300}, {"bundle_name": "요즘가족결합","condition": "500M + TV","discount_amount": 6600}, {"bundle_name": "패밀리결합","condition": "500M + TV","discount_amount": 5500}, {"bundle_name": "알뜰한 결합","condition": "500M + TV","discount_amount": 6600}, {"bundle_name": "요즘가족결합","condition": "1GB + TV","discount_amount": 8800}, {"bundle_name": "패밀리결합","condition": "1GB + TV","discount_amount": 5500}, {"bundle_name": "알뜰한 결합","condition": "1GB + TV","discount_amount": 8800}, {"bundle_name": "요즘가족결합","condition": "100M (단독)","discount_amount": 4400}, {"bundle_name": "패밀리결합","condition": "100M (단독)","discount_amount": 5500}, {"bundle_name": "알뜰한 결합","condition": "100M (단독)","discount_amount": 4400}, {"bundle_name": "요즘가족결합","condition": "500M (단독)","discount_amount": 11000}, {"bundle_name": "패밀리결합","condition": "500M (단독)","discount_amount": 11000}, {"bundle_name": "알뜰한 결합","condition": "500M (단독)","discount_amount": 11000}, {"bundle_name": "요즘가족결합","condition": "1GB (단독)","discount_amount": 13200}, {"bundle_name": "패밀리결합","condition": "1GB (단독)","discount_amount": 11000}, {"bundle_name": "알뜰한 결합","condition": "1GB (단독)","discount_amount": 13200}],
        "installationFees": {
            "weekday": {
                "internet_100_500_standalone": 36300,
                "internet_tv": 34100,
                "internet_tv_add": 34100,
                "internet_phone_landline": 44000,
                "internet_phone_voip": 37400,
                "internet_1g_standalone": 0,
                "internet_1g_tv": 22000
            },
            "weekend": {
                "internet_100_500_standalone": 45375,
                "internet_tv": 42625,
                "internet_tv_add": 42625,
                "internet_phone_landline": 51700,
                "internet_phone_voip": 45100,
                "internet_1g_standalone": 0,
                "internet_1g_tv": 27500
            },
            "promo_waiver": 0,
            "descriptions": {
                "internet_100_500_standalone": "인터넷 (100M/500M)",
                "internet_tv": "인터넷 + TV",
                "internet_tv_add": "인터넷 + TV + 추가TV",
                "internet_phone_landline": "인터넷 + 일반전화",
                "internet_phone_voip": "인터넷 + 070전화",
                "internet_1g_standalone": "1Giga 인터넷+WiFi (설치비 면제)",
                "internet_1g_tv": "1Giga 인터넷+WiFi + TV",
                "promo_waiver": "설치비 면제 프로모션",
                "none": "서비스 미선택"
            }
        }
    };
    
    // --- Helper Functions ---
    function findItemById(itemList, itemId) {
        if (!itemId || itemId === 'none') return null;
        return itemList.find(item => item.id === itemId) || null;
    }
    
    function processMobilePlans() {
        allMobilePlans = [];
        for (const tier in mobilePlanTiers) {
            mobilePlanTiers[tier].forEach(plan => {
                const price = parseInt(plan.price.replace(/[^0-9]/g, ''));
                const planId = `${plan.plan_name.replace(/[\s\(\)]/g, '_')}_${price}`;
                allMobilePlans.push({
                    id: planId,
                    name: plan.plan_name,
                    price: price,
                    network: plan.network_type,
                    url: plan.url,
                    tier: tier 
                });
            });
        }
        allMobilePlans.sort((a, b) => a.price - b.price);
    }
    
    function updateTvSubOptionsState() {
        const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        const isInternetStandalone = selectedInternetType === 'standalone';
        const isFirstTvPlanSelected = tvPlanEl.value !== 'none';
    
        const enableTvSubOptions = !isInternetStandalone && isFirstTvPlanSelected;
    
        tvStbEl.disabled = !enableTvSubOptions;
        additionalTvPlanEl.disabled = !enableTvSubOptions;
        phonePlanEl.disabled = isInternetStandalone; 
    
        if (!enableTvSubOptions) {
            tvStbEl.value = 'none';
            additionalTvPlanEl.value = 'none';
        }
        if (isInternetStandalone) {
            phonePlanEl.value = 'none';
        }
    }
    
    
    // --- Existing Configs (OnGajok, Gifts) ---
    // UPDATED On-Gajok Discount Logic
    const onGajokDiscountConfig = {
        "internet_discount_rate": {
            "0_9":    { "0_1": 0,    "1_2": 0,    "2_3": 0.05, "3_plus": 0.10 }, // 10년 미만
            "10_19":  { "0_1": 0,    "1_2": 0,    "2_3": 0.10, "3_plus": 0.30 }, // 10년 이상 ~ 20년 미만
            "20_29":  { "0_1": 0.05, "1_2": 0.10, "2_3": 0.20, "3_plus": 0.30 }, // 20년 이상 ~ 30년 미만
            "30_plus":{ "0_1": 0.10, "1_2": 0.20, "2_3": 0.30, "3_plus": 0.50 }  // 30년 이상
        },
        "mobileDiscountRate": { "0_9": 0, "10_19": 0, "20_29": 0.10, "30_plus": 0.30 } // Mobile discount remains the same
    };
    const yozoomGajokMobileDiscountReference = { 
        "100": [{ lines: 0, discount: 0 },{ lines: 1, discount: 3500 },{ lines: 2, discount: 7000 },{ lines: 3, discount: 18000 },{ lines: 4, discount: 18000 },{ lines: 5, discount: 18000 }],
        "500_1000": [{ lines: 0, discount: 0 },{ lines: 1, discount: 3500 },{ lines: 2, discount: 7000 },{ lines: 3, discount: 18000 },{ lines: 4, discount: 24000 },{ lines: 5, discount: 24000 }]
    };
    
    // --- Gift Tables (As per original structure, to be kept) ---
    const giftTableSktBase = { 
        "100": { "단독": 110000, "번들": 430000 }, 
        "500": { "단독": 170000, "번들": 480000 },
        "1000": { "단독": 170000, "번들": 480000 } 
    };
    const dongpanGiftTable = { 
        "33K": {"100": {"Economy": 55000, "Standard": 60000, "All": 65000, "단독": 0 }, "500": {"Economy": 60000, "Standard": 65000, "All": 70000, "단독": 0 }, "1000": {"Economy": 60000, "Standard": 65000, "All": 70000, "단독": 0 }},
        "69K": {"100": {"단독": 130000, "Economy": 159500, "Standard": 174000, "All": 188500 }, "500": {"단독": 140000, "Economy": 174000, "Standard": 188500, "All": 203000 }, "1000": {"단독": 140000, "Economy": 174000, "Standard": 188500, "All": 203000 }},
        "80K": {"100": {"단독": 162500, "Economy": 181500, "Standard": 198000, "All": 214500 }, "500": {"단독": 175000, "Economy": 198000, "Standard": 214500, "All": 231000 }, "1000": {"단독": 175000, "Economy": 198000, "Standard": 214500, "All": 231000 }}
    };
    
    // DOM Elements 
    const mobileDiscountDetailsContainerEl = document.getElementById('mobileDiscountDetailsContainer');
    const mobileDiscountBreakdownEl = document.getElementById('mobileDiscountBreakdown');
    const mobileDiscountNoteEl = document.getElementById('mobileDiscountNote');
    const internetTypeRadios = document.querySelectorAll('input[name="internetType"]');
    const internetPlanEl = document.getElementById('internetPlan');
    const wifiRouterEl = document.getElementById('wifiRouter');
    const tvPlanEl = document.getElementById('tvPlan');
    const tvStbEl = document.getElementById('tvStb');
    const additionalTvPlanEl = document.getElementById('additionalTvPlan');
    const phonePlanEl = document.getElementById('phonePlan');
    const mobileLinesCountEl = document.getElementById('mobileLinesCount');
    const mobileLinesContainerEl = document.getElementById('mobileLinesContainer');
    const dongpanSalesCheckEl = document.getElementById('dongpanSalesCheck');
    const dongpanUsimPolicyDetailsContainerEl = document.getElementById('dongpanUsimPolicyDetailsContainer');
    const discountTypeRadios = document.querySelectorAll('input[name="discountType"]');
    const bundleApplicationTimeRadios = document.querySelectorAll('input[name="bundleApplicationTime"]');
    const onGajokYearsGroupEl = document.getElementById('onGajokYearsGroup');
    const onGajokYearsEl = document.getElementById('onGajokYears');
    const internetUsageYearsGroupEl = document.getElementById('internetUsageYearsGroup');
    const internetUsageYearsEl = document.getElementById('internetUsageYears');
    const yozoomGajokDetailsToggleEl = document.getElementById('yozoomGajokDetailsToggle');
    const yozoomGajokDetailsContainerEl = document.getElementById('yozoomGajokDetailsContainer');
    const detailYgInternetDiscountEl = document.getElementById('detailYgInternetDiscount');
    const detailYgInternetTypeEl = document.getElementById('detailYgInternetType');
    const detailYgMobileDiscountEl = document.getElementById('detailYgMobileDiscount');
    const yozoomGajokInternetDiscountTiersEl = document.getElementById('yozoomGajokInternetDiscountTiers');
    const yozoomGajokMobileDiscountTiersEl = document.getElementById('yozoomGajokMobileDiscountTiers');
    const onGajokDetailsToggleEl = document.getElementById('onGajokDetailsToggle');
    const onGajokDetailsContainerEl = document.getElementById('onGajokDetailsContainer');
    const detailOgInternetDiscountEl = document.getElementById('detailOgInternetDiscount');
    const detailOgMobileDiscountEl = document.getElementById('detailOgMobileDiscount');
    const onGajokInternetDiscountTiersEl = document.getElementById('onGajokInternetDiscountTiers');
    const familySktDetailsToggleEl = document.getElementById('familySktDetailsToggle');
    const familySktDetailsContainerEl = document.getElementById('familySktDetailsContainer');
    const detailFsInternetDiscountEl = document.getElementById('detailFsInternetDiscount');
    const familyInternetDiscountTiersEl = document.getElementById('familyInternetDiscountTiers');
    const mvnoSktDetailsToggleEl = document.getElementById('mvnoSktDetailsToggle');
    const mvnoSktDetailsContainerEl = document.getElementById('mvnoSktDetailsContainer');
    const detailMsInternetDiscountEl = document.getElementById('detailMsInternetDiscount');
    const mvnoInternetDiscountTiersEl = document.getElementById('mvnoInternetDiscountTiers');
    const calculateButton = document.getElementById('calculateButton');
    const resetButton = document.getElementById('resetButton');
    const resultSection = document.getElementById('resultSection');
    const generateComparisonButton = document.getElementById('generateComparisonButton');
    const affiliateCardSelectEl = document.getElementById('affiliateCardSelect');
    const cardTierGroupEl = document.getElementById('cardTierGroup');
    const cardTierSelectEl = document.getElementById('cardTierSelect');
    
    const summaryMonthlyCostEl = document.getElementById('summaryMonthlyCost');
    const summaryTotalGiftEl = document.getElementById('summaryTotalGift');
    const summaryInternetDiscountEl = document.getElementById('summaryInternetDiscount');
    const summaryMobileDiscountEl = document.getElementById('summaryMobileDiscount');
    const toggleDetailsButtonEl = document.getElementById('toggleDetailsButton');
    const detailsContainerEl = document.getElementById('detailsContainer');
    
    const selectedInternetEl = document.getElementById('selectedInternet');
    const selectedTvEl = document.getElementById('selectedTv');
    const selectedStbEl = document.getElementById('selectedStb');
    const selectedAdditionalTvEl = document.getElementById('selectedAdditionalTv');
    const selectedPhoneEl = document.getElementById('selectedPhone');
    const selectedWifiEl = document.getElementById('selectedWifi');
    const selectedMobileCountEl = document.getElementById('selectedMobileCount');
    const selectedDiscountTypeEl = document.getElementById('selectedDiscountType');
    const selectedOnGajokYearsEl = document.getElementById('selectedOnGajokYears');
    const onGajokYearsResultContainerEl = document.getElementById('onGajokYearsResultContainer');
    const totalBaseInternetCostEl = document.getElementById('totalBaseInternetCost');
    const totalInternetDiscountAmountEl = document.getElementById('totalInternetDiscountAmount');
    const internetDiscountBreakdownEl = document.getElementById('internetDiscountBreakdown');
    const cardDiscountSummaryContainerEl = document.getElementById('cardDiscountSummaryContainer');
    const totalCardDiscountAmountEl = document.getElementById('totalCardDiscountAmount');
    const cardDiscountBreakdownEl = document.getElementById('cardDiscountBreakdown');
    const wifiRouterRentalCostDisplayEl = document.getElementById('wifiRouterRentalCostDisplay');
    const tvCostSummaryContainerEl = document.getElementById('tvCostSummaryContainer');
    const tvBaseCostDisplayEl = document.getElementById('tvBaseCostDisplay');
    const stbRentalCostDisplayEl = document.getElementById('stbRentalCostDisplay');
    const additionalTvCostSummaryContainerEl = document.getElementById('additionalTvCostSummaryContainer');
    const additionalTvCostDisplayEl = document.getElementById('additionalTvCostDisplay');
    const phoneCostSummaryContainerEl = document.getElementById('phoneCostSummaryContainer');
    const phoneBaseCostDisplayEl = document.getElementById('phoneBaseCostDisplay');
    const finalMonthlyCostEl = document.getElementById('finalMonthlyCost');
    const finalCostLabelTextEl = document.getElementById('finalCostLabelText');
    const finalCostLabelQualifierEl = document.getElementById('finalCostLabelQualifier');
    const installationCostResultEl = document.getElementById('installationCostResult');
    const installationCostDescriptionEl = document.getElementById('installationCostDescription');
    const giftBaseInternetEl = document.getElementById('giftBaseInternet');
    const additionalDongpanCashContainerEl = document.getElementById('additionalDongpanCashContainer');
    const giftAdditionalDongpanCashEl = document.getElementById('giftAdditionalDongpanCash');
    const giftTotalEl = document.getElementById('giftTotal');
    const giftEligibilityNoteEl = document.getElementById('giftEligibilityNote');
    const messageScriptSectionEl = document.getElementById('messageScriptSection');
    const memoScriptEl = document.getElementById('memoScript');
    const infoScriptEl = document.getElementById('infoScript');
    const completeScriptEl = document.getElementById('completeScript');
    const usimDongpanCompleteScriptEl = document.getElementById('usimDongpanCompleteScript');
    const sensitiveInfoLinkScriptEl = document.getElementById('sensitiveInfoLinkScript');
    // New script textareas
    const generateTco100MbpsButton = document.getElementById('generateTco100MbpsButton');
    const generateTco500MbpsButton = document.getElementById('generateTco500MbpsButton');
    const tcoComparisonResultScriptEl = document.getElementById('tcoComparisonResultScript');
    const penaltyAnalysisScriptEl = document.getElementById('penaltyAnalysisScript');
    const waiverInfoScriptEl = document.getElementById('waiverInfoScript');
    
    // --- AI 기능 관련 DOM 요소 ---
    const aiConsultationInputEl = document.getElementById('aiConsultationInput');
    const generateAiScriptButtonEl = document.getElementById('generateAiScriptButton');
    const aiLoadingIndicatorEl = document.getElementById('aiLoadingIndicator');
    const aiResultScriptEl = document.getElementById('aiResultScript');
    
    // --- 와이파이 선택 로직을 관리하는 헬퍼 함수 (수정됨) ---
    function manageWifiSelection() {
        const selectedInternetId = internetPlanEl.value;
        if (selectedInternetId === 'none') {
            wifiRouterEl.disabled = false;
            if (wifiRouterEl.value === 'wifi_router_yozoom_100M_tv') {
                wifiRouterEl.value = "wifi_router_default";
            }
            return;
        }
    
        const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        const selectedDiscountType = document.querySelector('input[name="discountType"]:checked').value;
    
        const internetPlanInfo = (selectedInternetType === 'bundle') ?
            findItemById(jsonData.internetPlans_tv_bundle_prices, selectedInternetId) :
            findItemById(jsonData.internetPlans_base, selectedInternetId);
    
        const tvSelected = tvPlanEl.value !== 'none';
    
        // "요즘우리집" 특별 와이파이 조건: 100M+TV결합+결합할인없음
        const isYozoomWifiCondition = internetPlanInfo &&
                                        internetPlanInfo.speed_mbps === 100 &&
                                        selectedInternetType === 'bundle' &&
                                        tvSelected &&
                                        selectedDiscountType === 'noBundleDiscount';
    
        if (isYozoomWifiCondition) {
            wifiRouterEl.value = "wifi_router_yozoom_100M_tv"; // 2,200원 옵션
            wifiRouterEl.disabled = true;
        } else {
            wifiRouterEl.disabled = false;
            // 다른 결합이 선택되었을 때, 만약 '요즘우리집' 공유기가 선택되어 있었다면 기본 공유기로 변경
            if (wifiRouterEl.value === 'wifi_router_yozoom_100M_tv') {
                wifiRouterEl.value = "wifi_router_default"; // 1,100원 옵션
            }
        }
    }
    
    
    // --- 토글 상세 내용을 업데이트하는 함수 ---
    function updateVisibleDetails() {
        allDetailSectionsSkt.forEach(section => {
            if (section.toggleEl && section.toggleEl.checked && section.updateFn) {
                section.updateFn();
            }
        });
    }
    
    
    // --- Populate Select Options ---
    function populateInternetPlansDropdown() {
        const selectedType = document.querySelector('input[name="internetType"]:checked').value;
        let plansToShow;
        if (selectedType === 'bundle') {
            plansToShow = jsonData.internetPlans_tv_bundle_prices;
        } else {
            plansToShow = jsonData.internetPlans_base;
        }
        const currentSelectedInternetId = internetPlanEl.value;
        
        populateSelectWithOptions(internetPlanEl, plansToShow, "선택 안함", 'id', 'name', 'price', 'note');
        
        const existingOption = plansToShow.find(p => p.id === currentSelectedInternetId);
        if (existingOption) {
            internetPlanEl.value = currentSelectedInternetId;
        } else if (plansToShow.length > 0) {
             internetPlanEl.value = plansToShow[0].id; 
        } else {
            internetPlanEl.value = 'none';
        }
        handleInternetTypeChange(); 
    }
    
    
    function populateSelectWithOptions(selectElement, items, defaultOptionText = "선택 안함", valueField = 'id', nameField = 'name', priceField = 'price', noteField = 'note') {
        if (!selectElement) {
            console.error("Select element not found for population:", selectElement);
            return;
        }
        selectElement.innerHTML = ''; 
        if (defaultOptionText && valueField === 'id') { 
            const defaultOpt = document.createElement('option');
            defaultOpt.value = 'none';
            defaultOpt.textContent = defaultOptionText;
            selectElement.appendChild(defaultOpt);
        }
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item[valueField];
            let displayText = item[nameField]; 
    
            if (priceField && item[priceField] > 0) {
                 displayText += ` (${item[priceField].toLocaleString()}원)`;
            } else if (noteField && item[noteField] && item.price === 0) { 
                 displayText += ` (${item[noteField]})`;
            } else if (noteField && item[noteField] && !item[priceField]) { 
                 displayText += ` (${item[noteField]})`;
            }
    
            option.textContent = displayText;
            option.dataset.price = item[priceField] !== undefined ? item[priceField] : 0;
            if(item.speed_mbps) option.dataset.speed = item.speed_mbps;
            if(item.type) option.dataset.type = item.type;
            if(item.channels) option.dataset.channels = item.channels;
            if(item.stb) option.dataset.defaultStb = item.stb; 
            if(item.note) option.dataset.note = item.note;
            
            selectElement.appendChild(option);
        });
    }

    function populateAffiliateCards() {
        affiliateCardSelectEl.innerHTML = '<option value="none">선택 안함</option>';

        const sktGroup = document.createElement('optgroup');
        sktGroup.label = "SKT 제휴카드";
        affiliateCards.skt.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = card.name;
            sktGroup.appendChild(option);
        });
        affiliateCardSelectEl.appendChild(sktGroup);
        
        const skbGroup = document.createElement('optgroup');
        skbGroup.label = "SK브로드밴드 제휴카드";
        affiliateCards.skb.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = card.name;
            skbGroup.appendChild(option);
        });
        affiliateCardSelectEl.appendChild(skbGroup);
    }
    
    function initializeSelects() {
        processMobilePlans();
        populateInternetPlansDropdown(); 
        populateAffiliateCards();
        
        const wifiOptions = jsonData.addOnServices.filter(s => s.name.includes("와이파이") || s.name.includes("공유기"));
        populateSelectWithOptions(wifiRouterEl, wifiOptions, "공유기 선택 안함(X)", 'id', 'name', 'price', 'note');
        
        const specialStbOptions = jsonData.addOnServices.filter(s => s.type === "AI STB" || s.type === "STB");
        populateSelectWithOptions(tvStbEl, specialStbOptions, "선택 안함 (기본셋톱 사용)", 'id', 'name', 'price', 'note');
        
        populateSelectWithOptions(tvPlanEl, jsonData.tvPackages, "선택 안함", 'id', 'name', 'price');
        
        populateSelectWithOptions(additionalTvPlanEl, jsonData.additionalTvPackages, "선택 안함", 'id', 'name', 'price');
        populateSelectWithOptions(phonePlanEl, jsonData.phonePlans, "선택 안함", 'id', 'name', 'price');
    }
    
    
    // Event Listeners
    internetTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            populateInternetPlansDropdown();
            manageWifiSelection();
            updateVisibleDetails();
            updateMobilePlanAvailability();
        });
    });
    
    mobileLinesCountEl.addEventListener('input', () => {
        updateMobileLinesInputs();
        updateVisibleDetails();
    });
    
    calculateButton.addEventListener('click', () => {
        const results = calculatePlanDetails();
        displayResults(results);
    });

    resetButton.addEventListener('click', setInitialDefaults);
    
    generateComparisonButton.addEventListener('click', generateComparisonScript);

    toggleDetailsButtonEl.addEventListener('click', () => {
        const isHidden = detailsContainerEl.classList.toggle('hidden');
        if (isHidden) {
            toggleDetailsButtonEl.innerHTML = '상세 요금 내역 펼쳐보기 ▼';
        } else {
            toggleDetailsButtonEl.innerHTML = '상세 요금 내역 접기 ▲';
        }
    });
    
    dongpanSalesCheckEl.addEventListener('change', function() {
        dongpanUsimPolicyDetailsContainerEl.classList.toggle('hidden', !this.checked);
        updateMobilePlanAvailability();
        if (!resultSection.classList.contains('hidden')) { 
            const results = calculatePlanDetails();
            displayResults(results);
        }
    });
    
    const allDetailSectionsSkt = [
        { radioValue: '요즘가족결합', toggleEl: yozoomGajokDetailsToggleEl, containerEl: yozoomGajokDetailsContainerEl, updateFn: updateYozoomGajokDetails },
        { radioValue: '온가족할인', toggleEl: onGajokDetailsToggleEl, containerEl: onGajokDetailsContainerEl, updateFn: updateOnGajokDetails },
        { radioValue: '패밀리결합', toggleEl: familySktDetailsToggleEl, containerEl: familySktDetailsContainerEl, updateFn: updateFamilySktDetails },
        { radioValue: '알뜰한 결합', toggleEl: mvnoSktDetailsToggleEl, containerEl: mvnoSktDetailsContainerEl, updateFn: updateMvnoSktDetails },
        { radioValue: 'noBundleDiscount', toggleEl: null, containerEl: null, updateFn: null } 
    ];
    
    discountTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            onGajokYearsGroupEl.classList.toggle('hidden', this.value !== '온가족할인');
            internetUsageYearsGroupEl.classList.toggle('hidden', this.value !== '온가족할인'); // Toggle new group
            
            if (this.value === 'noBundleDiscount' || this.value === '패밀리결합' || this.value === '알뜰한 결합') {
                mobileLinesCountEl.value = 0;
                mobileLinesCountEl.disabled = true;
            } else {
                mobileLinesCountEl.disabled = false;
                if (this.value === '요즘가족결합' || this.value === '온가족할인') {
                    if (parseInt(mobileLinesCountEl.value) === 0) {
                        mobileLinesCountEl.value = 1;
                    }
                }
            }
            updateMobileLinesInputs(); 
    
            manageWifiSelection();
    
            allDetailSectionsSkt.forEach(section => {
                if (section.containerEl) { 
                    let isVisible = false;
                    if (this.value === section.radioValue) { 
                        if (section.toggleEl) { 
                            isVisible = section.toggleEl.checked; 
                            if (isVisible && section.updateFn) {
                                section.updateFn();
                            }
                        }
                    } else { 
                        if(section.toggleEl) section.toggleEl.checked = false; 
                        isVisible = false; 
                    }
                    section.containerEl.classList.toggle('hidden', !isVisible);
                } else if (this.value !== section.radioValue && section.toggleEl) { 
                    section.toggleEl.checked = false;
                    if(section.containerEl) section.containerEl.classList.add('hidden');
                }
            });
            if (!resultSection.classList.contains('hidden')) { 
                const results = calculatePlanDetails();
                displayResults(results);
            } 
        });
    });
    
    allDetailSectionsSkt.forEach(section => {
        if (section.toggleEl) {
            section.toggleEl.addEventListener('change', function() {
                const selectedRadio = document.querySelector(`input[name="discountType"][value="${section.radioValue}"]`);
                if (selectedRadio && selectedRadio.checked) { 
                    section.containerEl.classList.toggle('hidden', !this.checked);
                    if (this.checked && section.updateFn) {
                        section.updateFn();
                    }
                }
            });
        }
    });
    
    function handleInternetTypeChange() {
        const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        const isStandaloneInternet = selectedInternetType === 'standalone';
    
        tvPlanEl.disabled = isStandaloneInternet;
        phonePlanEl.disabled = isStandaloneInternet; 
    
        if (isStandaloneInternet) {
            tvPlanEl.value = 'none'; 
            phonePlanEl.value = 'none';
        }
        updateTvSubOptionsState(); 
    }
    
    internetPlanEl.addEventListener('change', () => {
        manageWifiSelection();
        updateVisibleDetails();
        if (!resultSection.classList.contains('hidden')) { 
            const results = calculatePlanDetails();
            displayResults(results);
        }
    });
    
    
    tvPlanEl.addEventListener('change', () => { 
        updateTvSubOptionsState();
        manageWifiSelection();
        updateVisibleDetails();
        if (!resultSection.classList.contains('hidden')) { 
            const results = calculatePlanDetails();
            displayResults(results);
        }
    });
    
     [wifiRouterEl, tvStbEl, additionalTvPlanEl, phonePlanEl, onGajokYearsEl, internetUsageYearsEl, affiliateCardSelectEl, cardTierSelectEl].forEach(el => {
         if(el) el.addEventListener('change', () => {
             if(el.id === 'affiliateCardSelect') handleCardChange();
             updateVisibleDetails();
             if (!resultSection.classList.contains('hidden')) { 
                 const results = calculatePlanDetails();
                 displayResults(results);
             }
         });
     });

    bundleApplicationTimeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (!resultSection.classList.contains('hidden')) {
                 const results = calculatePlanDetails();
                 displayResults(results);
            }
        });
    });
    
    // --- AI 기능 이벤트 리스너 추가 ---
    generateAiScriptButtonEl.addEventListener('click', generateAIPersuasionScript);
    generateTco100MbpsButton.addEventListener('click', () => generateTcoScript('100M'));
    generateTco500MbpsButton.addEventListener('click', () => generateTcoScript('500M'));

    
    // Functions
    function updateMobilePlanAvailability() {
        const isInternetStandalone = document.querySelector('input[name="internetType"][value="standalone"]').checked;
        const isDongpanChecked = dongpanSalesCheckEl.checked;
        const shouldDisableTplanSave = isInternetStandalone && isDongpanChecked;
    
        const tPlanSaveId = allMobilePlans.find(p => p.name === 'T플랜세이브' && p.price === 33000)?.id;
        if (!tPlanSaveId) return;
    
        const mobilePlanSelects = document.querySelectorAll('[id^="mobilePlan"]');
        mobilePlanSelects.forEach(select => {
            const optionToModify = select.querySelector(`option[value="${tPlanSaveId}"]`);
            if (optionToModify) {
                const wasSelectedAndIsNowDisabled = optionToModify.selected && shouldDisableTplanSave;
                
                optionToModify.disabled = shouldDisableTplanSave;
    
                if (wasSelectedAndIsNowDisabled) {
                    const firstAvailableOption = Array.from(select.options).find(opt => !opt.disabled);
                    if (firstAvailableOption) {
                        select.value = firstAvailableOption.value;
                    }
                }
            }
        });
    }
    
    
    function updateMobileLinesInputs() {
        const discountType = document.querySelector('input[name="discountType"]:checked').value; // Get discount type inside
        const count = parseInt(mobileLinesCountEl.value) || 0;
        mobileLinesContainerEl.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const div = document.createElement('div');
            div.className = 'mobile-line-item';
            
            const planLabel = document.createElement('label');
            planLabel.htmlFor = `mobilePlan${i}`;
            planLabel.className = 'block text-sm font-medium text-slate-600 mb-1';
            planLabel.textContent = `회선 ${i + 1} 요금제`;
            
            const select = document.createElement('select');
            select.id = `mobilePlan${i}`;
            select.className = 'select-field';
            
            // Add "요금제 선택없음" for the first line
            if (i === 0) {
                const noPlanOption = document.createElement('option');
                noPlanOption.value = 'none';
                noPlanOption.textContent = '요금제 선택없음';
                select.appendChild(noPlanOption);
            }

            allMobilePlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.name} (${plan.price.toLocaleString()}원)`;
                select.appendChild(option);
            });
            
            // Set default value
            if (i === 0 && (discountType === '요즘가족결합' || discountType === '온가족할인')) {
                 select.value = 'none';
            } else {
                 const defaultPlanId = allMobilePlans.find(p => p.name === 'T플랜세이브' && p.price === 33000)?.id || allMobilePlans[0]?.id;
                 select.value = defaultPlanId;
            }
    
            const contractDiv = document.createElement('div');
            contractDiv.className = 'mt-2';
            
            const contractLabel = document.createElement('label');
            contractLabel.className = 'radio-label text-sm';
            
            const contractCheckbox = document.createElement('input');
            contractCheckbox.type = 'checkbox';
            contractCheckbox.id = `selectiveContractCheck${i}`;
            contractCheckbox.className = 'radio-input';
            
            contractLabel.appendChild(contractCheckbox);
            contractLabel.append(' 선택약정 (25% 추가 할인)');
            contractDiv.appendChild(contractLabel);
            
            div.appendChild(planLabel);
            div.appendChild(select);
            div.appendChild(contractDiv);
            mobileLinesContainerEl.appendChild(div);
            
            const recalculateOnChange = () => {
                if (!resultSection.classList.contains('hidden')) {
                    const results = calculatePlanDetails();
                    displayResults(results);
                }
                 updateVisibleDetails();
            };
    
            select.addEventListener('change', recalculateOnChange);
            contractCheckbox.addEventListener('change', recalculateOnChange);
        }
        updateMobilePlanAvailability();
        if (!resultSection.classList.contains('hidden')) { 
            const results = calculatePlanDetails();
            displayResults(results);
        }
    }
    
    function updateYozoomGajokDetails() {
        const selectedInternetId = internetPlanEl.value;
        const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        let internetPlanInfo;
        if (selectedInternetType === 'bundle') {
            internetPlanInfo = findItemById(jsonData.internetPlans_tv_bundle_prices, selectedInternetId) || { speed_mbps: 0, price: 0 };
        } else {
            internetPlanInfo = findItemById(jsonData.internetPlans_base, selectedInternetId) || { speed_mbps: 0, price: 0 };
        }
    
        const tvSelectedId = tvPlanEl.value;
        const tvPackage = findItemById(jsonData.tvPackages, tvSelectedId);
        const numMobileLines = parseInt(mobileLinesCountEl.value) || 0;
    
        let internetSpeedType = "";
        if (internetPlanInfo && internetPlanInfo.speed_mbps === 100) internetSpeedType = "100M";
        else if (internetPlanInfo && internetPlanInfo.speed_mbps === 500) internetSpeedType = "500M";
        else if (internetPlanInfo && internetPlanInfo.speed_mbps >= 1000) internetSpeedType = "1GB"; 
        
        let discountCondition = "";
        if (internetSpeedType) {
            discountCondition = tvPackage ? `${internetSpeedType} + TV` : `${internetSpeedType} (단독)`;
        }
    
        let currentInternetDiscountAmount = 0;
        const discountEntry = jsonData.bundleInternetDiscounts.find(
            d => d.bundle_name === "요즘가족결합" && d.condition === discountCondition
        );
        if (discountEntry) {
            currentInternetDiscountAmount = discountEntry.discount_amount;
        }
        
        detailYgInternetDiscountEl.textContent = currentInternetDiscountAmount.toLocaleString();
        detailYgInternetTypeEl.textContent = `(${discountCondition} 적용 시)`;
    
        let detailMobileD = 0;
        if (internetPlanInfo) {
            let mobileDiscountKey = internetPlanInfo.speed_mbps === 100 ? "100" : "500_1000"; 
            const tiers = yozoomGajokMobileDiscountReference[mobileDiscountKey]; 
            if (tiers) {
                const tier = tiers.find(t => t.lines === numMobileLines) || (numMobileLines > 0 && numMobileLines <=5 ? tiers.find(t => t.lines === Math.min(numMobileLines, 5)) : {discount:0});
                if (tier) detailMobileD = tier.discount;
            }
        }
        detailYgMobileDiscountEl.textContent = detailMobileD.toLocaleString();
    
        if(yozoomGajokInternetDiscountTiersEl) {
            yozoomGajokInternetDiscountTiersEl.innerHTML = '';
            ["100M", "500M", "1GB"].forEach(speed => {
                const standaloneDiscount = jsonData.bundleInternetDiscounts.find(d => d.bundle_name === "요즘가족결합" && d.condition === `${speed} (단독)`)?.discount_amount || 0;
                const tvBundleDiscount = jsonData.bundleInternetDiscounts.find(d => d.bundle_name === "요즘가족결합" && d.condition === `${speed} + TV`)?.discount_amount || 0;
                const li = document.createElement('li');
                li.textContent = `${speed}: 단독 시 ${standaloneDiscount.toLocaleString()}원, TV결합 시 ${tvBundleDiscount.toLocaleString()}원 할인`;
                yozoomGajokInternetDiscountTiersEl.appendChild(li);
            });
        }
        if(yozoomGajokMobileDiscountTiersEl && internetPlanInfo) { 
            yozoomGajokMobileDiscountTiersEl.innerHTML = ''; 
            const speedKey = internetPlanInfo.speed_mbps === 100 ? "100" : "500_1000";
            (yozoomGajokMobileDiscountReference[speedKey] || []).forEach(tier => {
                const li = document.createElement('li');
                li.textContent = `${tier.lines}회선 결합 시 총 ${tier.discount.toLocaleString()}원 모바일 할인 (참고용)`;
                yozoomGajokMobileDiscountTiersEl.appendChild(li);
            });
        }
    }
    
    function updateOnGajokDetails() {
        const selectedInternetId = internetPlanEl.value;
        let internetPlanForSpeed = findItemById(jsonData.internetPlans_base, selectedInternetId) || 
                                     findItemById(jsonData.internetPlans_tv_bundle_prices, selectedInternetId);
        if (!internetPlanForSpeed) {
            detailOgInternetDiscountEl.textContent = "0";
            detailOgMobileDiscountEl.textContent = "0%";
            if (onGajokInternetDiscountTiersEl) onGajokInternetDiscountTiersEl.innerHTML = '<li>인터넷 요금제를 선택해주세요.</li>';
            return;
        }
        
        const standalonePlanForOnGajok = jsonData.internetPlans_base.find(p => p.speed_mbps === internetPlanForSpeed.speed_mbps);
        if (!standalonePlanForOnGajok) {
             detailOgInternetDiscountEl.textContent = "0";
             detailOgMobileDiscountEl.textContent = "0%";
             if (onGajokInternetDiscountTiersEl) onGajokInternetDiscountTiersEl.innerHTML = '<li>해당 속도의 단독 요금제 정보를 찾을 수 없습니다.</li>';
             return;
        }
    
        const internetPriceForCalc = standalonePlanForOnGajok.price; 
        const yearsKey = onGajokYearsEl.value;
        const internetYearsKey = internetUsageYearsEl.value; // NEW
        const internetDiscountRate = onGajokDiscountConfig.internet_discount_rate[yearsKey]?.[internetYearsKey] || 0; // UPDATED
        const mobileDiscountRate = onGajokDiscountConfig.mobileDiscountRate[yearsKey] || 0;
        const calculatedInternetDiscount = Math.floor(internetPriceForCalc * internetDiscountRate);
        
        detailOgInternetDiscountEl.textContent = calculatedInternetDiscount.toLocaleString();
        detailOgMobileDiscountEl.textContent = `${(mobileDiscountRate * 100).toFixed(0)}%`;
    
        if (onGajokInternetDiscountTiersEl) {
            onGajokInternetDiscountTiersEl.innerHTML = '';
            const yearTextOption = onGajokYearsEl.querySelector(`option[value="${yearsKey}"]`);
            const yearText = yearTextOption ? yearTextOption.textContent : yearsKey;

            const headerLi = document.createElement('li');
            headerLi.innerHTML = `<strong>${yearText}</strong>의 인터넷 사용 기간별 할인율 (기준: ${standalonePlanForOnGajok.name} ${internetPriceForCalc.toLocaleString()}원):`;
            onGajokInternetDiscountTiersEl.appendChild(headerLi);

            const subUl = document.createElement('ul');
            subUl.className = 'list-disc list-inside ml-4';
            onGajokInternetDiscountTiersEl.appendChild(subUl);

            const internetYearOptions = Array.from(internetUsageYearsEl.options);
            const ratesForSelectedYears = onGajokDiscountConfig.internet_discount_rate[yearsKey];

            for(const option of internetYearOptions) {
                const iYearsKey = option.value;
                const iYearsText = option.text;
                const rate = ratesForSelectedYears[iYearsKey] || 0;
                const exampleDiscount = Math.floor(internetPriceForCalc * rate);
                const li = document.createElement('li');
                li.innerHTML = `${iYearsText}: <strong>${(rate * 100).toFixed(0)}%</strong> (${exampleDiscount.toLocaleString()}원) 할인`;
                if(iYearsKey === internetYearsKey) {
                    li.style.fontWeight = 'bold';
                    li.style.color = '#dc2626'; // SK Red
                }
                subUl.appendChild(li);
            }
        }
    }
    
    function updateFamilySktDetails() { 
        const selectedInternetId = internetPlanEl.value;
         const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        let internetPlanInfo;
        if (selectedInternetType === 'bundle') {
            internetPlanInfo = findItemById(jsonData.internetPlans_tv_bundle_prices, selectedInternetId) || { speed_mbps: 0 };
        } else {
            internetPlanInfo = findItemById(jsonData.internetPlans_base, selectedInternetId) || { speed_mbps: 0 };
        }
    
        const tvSelectedId = tvPlanEl.value;
        const tvPackage = findItemById(jsonData.tvPackages, tvSelectedId);
    
        let internetSpeedType = "";
        if (internetPlanInfo && internetPlanInfo.speed_mbps === 100) internetSpeedType = "100M";
        else if (internetPlanInfo && internetPlanInfo.speed_mbps === 500) internetSpeedType = "500M";
        else if (internetPlanInfo && internetPlanInfo.speed_mbps >= 1000) internetSpeedType = "1GB";
    
        let discountCondition = "";
         if (internetSpeedType) {
            discountCondition = tvPackage ? `${internetSpeedType} + TV` : `${internetSpeedType} (단독)`;
        }
        
        let currentInternetDiscountAmount = 0;
        const discountEntry = jsonData.bundleInternetDiscounts.find(
            d => d.bundle_name === "패밀리결합" && d.condition === discountCondition
        );
        if (discountEntry) {
            currentInternetDiscountAmount = discountEntry.discount_amount;
        }
        
        detailFsInternetDiscountEl.textContent = currentInternetDiscountAmount.toLocaleString();
         if(familyInternetDiscountTiersEl) {
            familyInternetDiscountTiersEl.innerHTML = '';
            ["100M", "500M", "1GB"].forEach(speed => {
                const standaloneDiscount = jsonData.bundleInternetDiscounts.find(d => d.bundle_name === "패밀리결합" && d.condition === `${speed} (단독)`)?.discount_amount || 0;
                const tvBundleDiscount = jsonData.bundleInternetDiscounts.find(d => d.bundle_name === "패밀리결합" && d.condition === `${speed} + TV`)?.discount_amount || 0;
                 const li = document.createElement('li');
                li.textContent = `${speed}: 단독 시 ${standaloneDiscount.toLocaleString()}원, TV결합 시 ${tvBundleDiscount.toLocaleString()}원 할인`;
                familyInternetDiscountTiersEl.appendChild(li);
            });
        }
    }
    
    function updateMvnoSktDetails() { 
        const selectedInternetId = internetPlanEl.value;
         const selectedInternetType = document.querySelector('input[name="internetType"]:checked').value;
        let internetPlanInfo;
        if (selectedInternetType === 'bundle') {
            internetPlanInfo = findItemById(jsonData.internetPlans_tv_bundle_prices, selectedInternetId) || { speed_mbps: 0 };
        } else {
            internetPlanInfo = findItemById(jsonData.internetPlans_base, selectedInternetId) || { speed_mbps: 0 };
        }
        const tvSelectedId = tvPlanEl.value;
        const tvPackage = findItemById(jsonData.tvPackages, tvSelectedId);
    
        let internetSpeedType = "";
        if (internetPlanInfo && internetPlanInfo.speed_mbps === 100) internetSpeedType = "100M";
        else if (internetPlanInfo && internetPlanInfo.speed_mbps === 500) internetSpeedType = "500M";
        else if (internetPlanInfo && internetPlanInfo.speed_mbps >= 1000) internetSpeedType = "1GB";
        
        let discountCondition = "";
        if (internetSpeedType) {
            discountCondition = tvPackage ? `${internetSpeedType} + TV` : `${internetSpeedType} (단독)`;
        }
        
        let currentInternetDiscountAmount = 0;
        const discountEntry = jsonData.bundleInternetDiscounts.find(
            d => d.bundle_name === "알뜰한 결합" && d.condition === discountCondition
        );
        if (discountEntry) {
            currentInternetDiscountAmount = discountEntry.discount_amount;
        }
        
        detailMsInternetDiscountEl.textContent = currentInternetDiscountAmount.toLocaleString();
        if(mvnoInternetDiscountTiersEl) {
            mvnoInternetDiscountTiersEl.innerHTML = '';
             ["100M", "500M", "1GB"].forEach(speed => {
                const standaloneDiscount = jsonData.bundleInternetDiscounts.find(d => d.bundle_name === "알뜰한 결합" && d.condition === `${speed} (단독)`)?.discount_amount || 0;
                const tvBundleDiscount = jsonData.bundleInternetDiscounts.find(d => d.bundle_name === "알뜰한 결합" && d.condition === `${speed} + TV`)?.discount_amount || 0;
                const li = document.createElement('li');
                li.textContent = `${speed}: 단독 시 ${standaloneDiscount.toLocaleString()}원, TV결합 시 ${tvBundleDiscount.toLocaleString()}원 할인`;
                mvnoInternetDiscountTiersEl.appendChild(li);
            });
        }
    }

    function handleCardChange() {
        const selectedCardId = affiliateCardSelectEl.value;
        cardTierSelectEl.innerHTML = '';
        if (selectedCardId === 'none') {
            cardTierGroupEl.classList.add('hidden');
            return;
        }

        const cardData = affiliateCards.skt.find(c => c.id === selectedCardId) || affiliateCards.skb.find(c => c.id === selectedCardId);
        
        if (cardData && cardData.tiers) {
            cardTierSelectEl.innerHTML = '<option value="none">실적 구간 선택</option>';
            cardData.tiers.forEach((tier, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = tier.label;
                cardTierSelectEl.appendChild(option);
            });
            cardTierGroupEl.classList.remove('hidden');
        } else {
            cardTierGroupEl.classList.add('hidden');
        }
    }
    
    function calculatePlanDetails(forcedInternetPlanId = null) {
        const selectedInternetId = forcedInternetPlanId ? forcedInternetPlanId : internetPlanEl.value;
        const selectedInternetTypeRadio = document.querySelector('input[name="internetType"]:checked').value;
        
        const selectedWifiId = wifiRouterEl.value;
        let selectedTvPackageId = tvPlanEl.value;
        let selectedAdditionalStbId = tvStbEl.value; 
        let selectedAdditionalTvId = additionalTvPlanEl.value;
        let selectedPhonePlanId = phonePlanEl.value;
    
        if (selectedInternetTypeRadio === 'standalone') {
            selectedTvPackageId = 'none';
            selectedAdditionalStbId = 'none';
            selectedAdditionalTvId = 'none';
            selectedPhonePlanId = 'none'; 
        }
    
        const numMobileLines = parseInt(mobileLinesCountEl.value) || 0;
        const isDongpanSalesChecked = dongpanSalesCheckEl.checked;
        const discountType = document.querySelector('input[name="discountType"]:checked').value; 
        const selectedBundleApplicationTime = document.querySelector('input[name="bundleApplicationTime"]:checked').value;
        const installationTime = document.querySelector('input[name="installationTime"]:checked').value; 
        const selectedYearsKeyOnGajok = onGajokYearsEl.value;
        const selectedInternetUsageKey = internetUsageYearsEl.value; // NEW
        
        let internetPriceAsSelectedByDropdown = 0; 
        let internetDiscountAmount = 0;
        let internetDiscountBreakdownText = "";
    
        let finalInternetPlan = null; 
         if (selectedInternetId !== 'none') {
             if (selectedInternetTypeRadio === 'bundle') {
                 finalInternetPlan = findItemById(jsonData.internetPlans_tv_bundle_prices, selectedInternetId);
             } else {
                 finalInternetPlan = findItemById(jsonData.internetPlans_base, selectedInternetId);
             }
        }
        
        const tvPackage = (selectedInternetTypeRadio === 'bundle') ? findItemById(jsonData.tvPackages, selectedTvPackageId) : null;
    
        if (finalInternetPlan) { 
            internetPriceAsSelectedByDropdown = finalInternetPlan.price;
        } else { 
            finalInternetPlan = { price: 0, speed_mbps: 0, name: "미선택" }; 
        }
        
        let displayInternetBasePrice = internetPriceAsSelectedByDropdown; 
        let calculationBaseForInternetDiscount = internetPriceAsSelectedByDropdown; 
    
        if (discountType === "온가족할인" && finalInternetPlan && finalInternetPlan.speed_mbps > 0) {
            const standalonePlanForOnGajok = jsonData.internetPlans_base.find(p => p.speed_mbps === finalInternetPlan.speed_mbps);
            if (standalonePlanForOnGajok) {
                calculationBaseForInternetDiscount = standalonePlanForOnGajok.price; 
                if (selectedBundleApplicationTime === 'pre' || selectedInternetTypeRadio === 'standalone') {
                    displayInternetBasePrice = standalonePlanForOnGajok.price; 
                } else { 
                    displayInternetBasePrice = internetPriceAsSelectedByDropdown; 
                }
            }
        }
        
        const wifiAddon = findItemById(jsonData.addOnServices, selectedWifiId);
        let originalWifiPrice = 0; 
        let currentWifiComponentCost = 0; 
        if (wifiAddon) {
            originalWifiPrice = wifiAddon.price; 
             if (wifiAddon.id === "wifi_router_yozoom_100M_tv") {
                if (finalInternetPlan.speed_mbps === 100 && selectedInternetTypeRadio === 'bundle' && tvPackage) { 
                    currentWifiComponentCost = wifiAddon.price; 
                } else {
                     currentWifiComponentCost = 0; 
                     originalWifiPrice = 0; 
                }
            } else {
                currentWifiComponentCost = wifiAddon.price;
            }
        }
    
        let tvComponentCost = 0;
        if (tvPackage) {
            tvComponentCost = tvPackage.price;
        }
    
        let additionalStbComponentCost = 0;
        const additionalStbAddon = (selectedInternetTypeRadio === 'bundle' && tvPackage) ? findItemById(jsonData.addOnServices, selectedAdditionalStbId) : null;
        if (additionalStbAddon) {
            additionalStbComponentCost = additionalStbAddon.price;
        }
        
        let additionalTvComponentCost = 0;
        const additionalTvPackage = (selectedInternetTypeRadio === 'bundle' && tvPackage) ? findItemById(jsonData.additionalTvPackages, selectedAdditionalTvId) : null;
        if (additionalTvPackage) {
            additionalTvComponentCost = additionalTvPackage.price;
        }
    
        let phoneComponentCost = 0;
        const phonePlan = (selectedInternetTypeRadio === 'bundle' || !phonePlanEl.disabled) ? findItemById(jsonData.phonePlans, selectedPhonePlanId) : null;
        if (phonePlan) {
            phoneComponentCost = phonePlan.price;
        }
    
        if (finalInternetPlan && finalInternetPlan.price > 0 && discountType !== "noBundleDiscount") { 
            if (discountType === "온가족할인") {
                let rate = 0; // UPDATED LOGIC START
                if (onGajokDiscountConfig.internet_discount_rate[selectedYearsKeyOnGajok] && onGajokDiscountConfig.internet_discount_rate[selectedYearsKeyOnGajok][selectedInternetUsageKey] !== undefined) {
                    rate = onGajokDiscountConfig.internet_discount_rate[selectedYearsKeyOnGajok][selectedInternetUsageKey];
                } // UPDATED LOGIC END
                
                internetDiscountAmount = Math.floor(calculationBaseForInternetDiscount * rate); 
                internetDiscountBreakdownText = `(온가족할인 ${ (rate * 100).toFixed(0)}% of ${calculationBaseForInternetDiscount.toLocaleString()}원 적용)`;
            } else { 
                let internetSpeedType = "";
                if (finalInternetPlan.speed_mbps === 100) internetSpeedType = "100M";
                else if (finalInternetPlan.speed_mbps === 500) internetSpeedType = "500M";
                else if (finalInternetPlan.speed_mbps >= 1000) internetSpeedType = "1GB";
    
                let conditionString = "";
                if (internetSpeedType) {
                    conditionString = tvPackage ? `${internetSpeedType} + TV` : `${internetSpeedType} (단독)`;
                }
                
                const bundleDiscountInfo = jsonData.bundleInternetDiscounts.find(
                    d => d.bundle_name === discountType && d.condition === conditionString
                );
                if (bundleDiscountInfo) {
                    internetDiscountAmount = bundleDiscountInfo.discount_amount;
                    internetDiscountBreakdownText = `(${discountType} ${conditionString} 할인 적용)`;
                } else {
                    internetDiscountAmount = 0;
                    internetDiscountBreakdownText = `(${discountType} 조건 불일치 또는 할인 없음)`;
                }
            }
            internetDiscountAmount = Math.min(displayInternetBasePrice, internetDiscountAmount); 
        } else { 
            internetDiscountAmount = 0; 
            internetDiscountBreakdownText = discountType === "noBundleDiscount" ? "(결합 할인 없음)" : "";
        }
    
        let effectiveInternetDiscount = internetDiscountAmount;
        if (selectedBundleApplicationTime === 'post' && discountType !== "noBundleDiscount") { 
            effectiveInternetDiscount = 0;
        }
        
        let actualInternetCostComponent = displayInternetBasePrice - effectiveInternetDiscount;
    
        let wifiDiscountForOnGajok = 0;
        let actualWifiCostComponent = currentWifiComponentCost; 
    
        if (discountType === "온가족할인" && wifiAddon && finalInternetPlan.speed_mbps < 1000 ) {
            let wifiBaseForOnGajokDiscount = 0;
            if (wifiAddon.id === "wifi_router_default") { 
                wifiBaseForOnGajokDiscount = wifiAddon.price;
            } else if (wifiAddon.id === "wifi_router_yozoom_100M_tv") {
                if (finalInternetPlan.speed_mbps === 100 && selectedInternetTypeRadio === 'bundle' && tvPackage) {
                     wifiBaseForOnGajokDiscount = wifiAddon.price; 
                }
            }
    
            if (wifiBaseForOnGajokDiscount > 0) {
                const wifiDiscountRate = onGajokDiscountConfig.internet_discount_rate[selectedYearsKeyOnGajok]?.[selectedInternetUsageKey] || 0;
                wifiDiscountForOnGajok = Math.floor(wifiBaseForOnGajokDiscount * wifiDiscountRate);
                if (selectedBundleApplicationTime === 'pre') {
                    actualWifiCostComponent = wifiBaseForOnGajokDiscount - wifiDiscountForOnGajok;
                } else { 
                    actualWifiCostComponent = wifiBaseForOnGajokDiscount; 
                }
            } else if (wifiAddon.id === "wifi_router_yozoom_100M_tv" && !(finalInternetPlan.speed_mbps === 100 && selectedInternetTypeRadio === 'bundle' && tvPackage)) {
                actualWifiCostComponent = 0; 
            }
        }
         if (selectedBundleApplicationTime === 'post' && discountType !== "온가족할인") { 
            actualWifiCostComponent = currentWifiComponentCost;
        }
        
        let totalSumBeforeDiscountForAllServices = 
            internetPriceAsSelectedByDropdown + 
            originalWifiPrice + 
            (tvPackage ? tvPackage.price : 0) +
            (additionalStbAddon ? additionalStbAddon.price : 0) +
            (additionalTvPackage ? additionalTvPackage.price : 0) +
            (phonePlan ? phonePlan.price : 0);
    
        let totalActualDiscountIfApplied = internetDiscountAmount + wifiDiscountForOnGajok; 
    
        let finalMonthlyCostCalculated = 
            (displayInternetBasePrice - internetDiscountAmount) + 
            (originalWifiPrice - wifiDiscountForOnGajok) +  
            (tvPackage ? tvPackage.price : 0) +
            (additionalStbAddon ? additionalStbAddon.price : 0) +
            (additionalTvPackage ? additionalTvPackage.price : 0) +
            (phonePlan ? phonePlan.price : 0);
        
        let uiFinalMonthlyCostToDisplay;
        if (selectedBundleApplicationTime === 'pre') {
            uiFinalMonthlyCostToDisplay = finalMonthlyCostCalculated;
        } else { 
            uiFinalMonthlyCostToDisplay = totalSumBeforeDiscountForAllServices;
        }

        // --- Card Discount Calculation ---
        let cardDiscount = 0;
        let selectedCardName = null;
        let selectedCardTierLabel = null;
        const selectedCardId = affiliateCardSelectEl.value;
        const selectedTierIndex = cardTierSelectEl.value;

        if (selectedCardId !== 'none' && selectedTierIndex !== 'none') {
            const cardData = affiliateCards.skt.find(c => c.id === selectedCardId) || affiliateCards.skb.find(c => c.id === selectedCardId);
            if (cardData && cardData.tiers[selectedTierIndex]) {
                const tier = cardData.tiers[selectedTierIndex];
                cardDiscount = tier.discount;
                selectedCardName = cardData.name;
                selectedCardTierLabel = tier.label;
            }
        }
        uiFinalMonthlyCostToDisplay -= cardDiscount;

    
        let totalMobileDiscount = 0;
        const perLineDiscounts = [];
        if (numMobileLines > 0 && (discountType === '요즘가족결합' || discountType === '온가족할인')) {
            let yozoomTotalDiscount = 0;
            if (discountType === '요즘가족결합' && finalInternetPlan) {
                let mobileDiscountKey = finalInternetPlan.speed_mbps === 100 ? "100" : "500_1000";
                const tiers = yozoomGajokMobileDiscountReference[mobileDiscountKey];
                const tier = tiers.find(t => t.lines === numMobileLines) || (numMobileLines > 0 && numMobileLines <= 5 ? tiers.find(t => t.lines === Math.min(numMobileLines, 5)) : { discount: 0 });
                if (tier) yozoomTotalDiscount = tier.discount;
            }
    
            for (let i = 0; i < numMobileLines; i++) {
                const mobilePlanSelect = document.getElementById(`mobilePlan${i}`);
                const contractCheckbox = document.getElementById(`selectiveContractCheck${i}`);
                if (!mobilePlanSelect || mobilePlanSelect.value === 'none') continue;
    
                const selectedPlan = allMobilePlans.find(p => p.id === mobilePlanSelect.value);
                if (!selectedPlan) continue;
    
                let bundleDiscount = 0;
                if (discountType === '요즘가족결합') {
                    const activeLines = Array.from(document.querySelectorAll('[id^="mobilePlan"]')).filter(s => s.value !== 'none').length;
                    bundleDiscount = (activeLines > 0) ? Math.floor(yozoomTotalDiscount / activeLines) : 0;
                } else if (discountType === '온가족할인') {
                    const mobileDiscountRate = onGajokDiscountConfig.mobileDiscountRate[selectedYearsKeyOnGajok] || 0;
                    bundleDiscount = Math.floor(selectedPlan.price * mobileDiscountRate);
                }
    
                let contractDiscount = 0;
                if (contractCheckbox && contractCheckbox.checked) {
                    contractDiscount = Math.floor(selectedPlan.price * 0.25);
                }
    
                const totalPerLineDiscount = bundleDiscount + contractDiscount;
                perLineDiscounts.push({ plan: selectedPlan, discount: totalPerLineDiscount, bundleDiscount, contractDiscount });
                totalMobileDiscount += totalPerLineDiscount;
            }
        }
        
        let calculatedInstallationFee = 0;
        let feeDescriptionKey = 'none';

        if (installationTime !== 'promo_waiver') {
            const timeKey = installationTime;
            const feesForTime = jsonData.installationFees[timeKey];

            const hasInternetService = !!finalInternetPlan && finalInternetPlan.price > 0;
            const is1Giga = hasInternetService && finalInternetPlan.speed_mbps >= 1000;
            const hasTvService = !!tvPackage;
            const hasAdditionalTvService = !!additionalTvPackage;
            const hasPhoneService = !!phonePlan;
            const isLandline = hasPhoneService && phonePlan.id.includes('landline');
            const isVoip = hasPhoneService && !isLandline;

            if (is1Giga) {
                feeDescriptionKey = hasTvService ? 'internet_1g_tv' : 'internet_1g_standalone';
            } else if (hasInternetService) {
                if (isLandline) {
                    feeDescriptionKey = 'internet_phone_landline';
                } else if (isVoip) {
                    feeDescriptionKey = 'internet_phone_voip';
                } else if (hasAdditionalTvService) {
                    feeDescriptionKey = 'internet_tv_add';
                } else if (hasTvService) {
                    feeDescriptionKey = 'internet_tv';
                } else {
                    feeDescriptionKey = 'internet_100_500_standalone';
                }
            }
            calculatedInstallationFee = feesForTime[feeDescriptionKey] ?? 0;
        } else {
            feeDescriptionKey = 'promo_waiver';
            calculatedInstallationFee = 0;
        }
    
        let baseInternetGift = 0;
        let additionalDongpanCashSum = 0;
        let giftNote = "";
    
        const internetSpeedForGift = finalInternetPlan ? finalInternetPlan.speed_mbps : 0; 
        const isTvBundledForGift = !!tvPackage;
        const giftKeyForBase = isTvBundledForGift ? "번들" : "단독";
        const speedKeyForGift = String(internetSpeedForGift);
    
        if (giftTableSktBase[speedKeyForGift] && giftTableSktBase[speedKeyForGift][giftKeyForBase] !== undefined) {
            baseInternetGift = giftTableSktBase[speedKeyForGift][giftKeyForBase];
        }
        
        if (isDongpanSalesChecked) {
            let qualifyingDongpanMobiles = 0;
            for (let i = 0; i < numMobileLines; i++) {
                const mobilePlanSelect = document.getElementById(`mobilePlan${i}`);
                if (!mobilePlanSelect || mobilePlanSelect.value === 'none') continue;
                const selectedPlan = allMobilePlans.find(p => p.id === mobilePlanSelect.value);
                if (!selectedPlan) continue;
                const mobileFee = selectedPlan.price;
                
                let mobileFeeTier = null;
                if (mobileFee >= 33000 && mobileFee < 69000) mobileFeeTier = "33K";
                else if (mobileFee >= 69000 && mobileFee < 79000) mobileFeeTier = "69K"; 
                else if (mobileFee >= 79000) mobileFeeTier = "80K"; 
    
                if (mobileFeeTier) {
                    qualifyingDongpanMobiles++;
                    let internetTypeForDongpan = speedKeyForGift;
                    
                    let tvCategoryForDongpan = "단독";
                    if (tvPackage) {
                        if (tvPackage.name.includes("이코노미")) tvCategoryForDongpan = "Economy";
                        else if (tvPackage.name.includes("스탠다드")) tvCategoryForDongpan = "Standard";
                        else if (tvPackage.name.includes("ALL")) tvCategoryForDongpan = "All";
                    }
    
                    if (dongpanGiftTable[mobileFeeTier] && dongpanGiftTable[mobileFeeTier][internetTypeForDongpan] &&
                        dongpanGiftTable[mobileFeeTier][internetTypeForDongpan][tvCategoryForDongpan] !== undefined) {
                        additionalDongpanCashSum += dongpanGiftTable[mobileFeeTier][internetTypeForDongpan][tvCategoryForDongpan];
                    }
                }
            }
            if (numMobileLines > 0 && qualifyingDongpanMobiles === 0 && additionalDongpanCashSum === 0) {
                giftNote = "동판 추가 사은품: 선택된 모바일 요금제가 동판 사은품 지급 기준(첫번째 회선 3.3만 이상 등)에 해당하지 않습니다.";
            } else if (numMobileLines === 0 && isDongpanSalesChecked) {
                giftNote = "동판 추가 사은품: 모바일 회선이 없어 동판 추가 사은품 조건이 충족되지 않았습니다."
            }
        }

        const totalGiftAmount = baseInternetGift + additionalDongpanCashSum;

        const discountTypeMapSkt = {"요즘가족결합": "요즘가족결합","온가족할인": "온가족할인", "패밀리결합": "패밀리결합", "알뜰한 결합": "알뜰한 결합", "noBundleDiscount": "결합 할인 없음"};

        let wifiDisplayText = actualWifiCostComponent.toLocaleString();
        if (discountType === "온가족할인" && wifiAddon && (wifiAddon.id === "wifi_router_default" || wifiAddon.id === "wifi_router_yozoom_100M_tv") && finalInternetPlan.speed_mbps < 1000 && wifiDiscountForOnGajok > 0) {
            let originalPriceForDisplay = 0;
             if (wifiAddon.id === "wifi_router_default") {
                 originalPriceForDisplay = wifiAddon.price;
            } else if (wifiAddon.id === "wifi_router_yozoom_100M_tv" && finalInternetPlan.speed_mbps === 100 && selectedInternetTypeRadio === 'bundle' && tvPackage) {
                 originalPriceForDisplay = wifiAddon.price;
            }
    
             if (originalPriceForDisplay > 0 && actualWifiCostComponent < originalPriceForDisplay && selectedBundleApplicationTime === 'pre') { 
                 wifiDisplayText = `${originalPriceForDisplay.toLocaleString()}원에서 ${wifiDiscountForOnGajok.toLocaleString()}원 할인 → ${actualWifiCostComponent.toLocaleString()}`;
            } else if (selectedBundleApplicationTime === 'post'){
                 wifiDisplayText = originalWifiPrice.toLocaleString(); 
            }
        } else if (selectedBundleApplicationTime === 'post') {
             wifiDisplayText = originalWifiPrice.toLocaleString(); 
        }

        return {
            finalMonthlyCost: uiFinalMonthlyCostToDisplay,
            totalGiftAmount: totalGiftAmount,
            totalBaseSum: totalSumBeforeDiscountForAllServices,
            internetDiscountAmount: internetDiscountAmount,
            totalMobileDiscount: totalMobileDiscount,
            installationFee: calculatedInstallationFee,
            baseInternetGift: baseInternetGift,
            additionalDongpanCashSum: additionalDongpanCashSum,
            cardDiscount: cardDiscount,
            selectedOptions: {
                internetPlan: finalInternetPlan,
                tvPackage: tvPackage,
                additionalStb: additionalStbAddon,
                additionalTv: additionalTvPackage,
                phonePlan: phonePlan,
                wifi: wifiAddon,
                discountType: discountType,
                discountTypeName: discountTypeMapSkt[discountType] || discountType,
                bundleApplicationTime: selectedBundleApplicationTime,
                onGajokYearsKey: selectedYearsKeyOnGajok,
                isDongpan: isDongpanSalesChecked,
                numMobileLines: numMobileLines,
                selectedCardName: selectedCardName,
                selectedCardTierLabel: selectedCardTierLabel
            },
            perLineDiscounts: perLineDiscounts,
            installationFeeKey: feeDescriptionKey,
            internetDiscountBreakdownText: internetDiscountBreakdownText,
            wifiDisplayText: wifiDisplayText,
            displayInternetBasePrice: displayInternetBasePrice,
            giftNote: giftNote
        };
    }

    function displayResults(results) {
        // SUMMARY SECTION
        summaryMonthlyCostEl.textContent = `${results.finalMonthlyCost.toLocaleString()}원`;
        const monthlyCostContainer = summaryMonthlyCostEl.parentElement;
        const existingOriginalCost = monthlyCostContainer.querySelector('.original-cost-display');
        if (existingOriginalCost) {
            existingOriginalCost.remove();
        }
        
        const totalBaseWithCard = results.totalBaseSum + results.cardDiscount;
        const totalDiscountApplied = totalBaseWithCard - results.finalMonthlyCost;

        if (totalDiscountApplied > 0) {
            const originalCostEl = document.createElement('p');
            originalCostEl.className = 'text-sm text-slate-500 line-through -mt-1 original-cost-display';
            originalCostEl.textContent = `할인 전 ${totalBaseWithCard.toLocaleString()}원`;
            summaryMonthlyCostEl.insertAdjacentElement('afterend', originalCostEl);
        }
        summaryTotalGiftEl.textContent = `${results.totalGiftAmount.toLocaleString()}원`;
        summaryInternetDiscountEl.textContent = `- ${(results.internetDiscountAmount + results.cardDiscount).toLocaleString()}원`;
        summaryMobileDiscountEl.textContent = `- ${results.totalMobileDiscount.toLocaleString()}원`;

        // DETAILS SECTION
        selectedInternetEl.textContent = results.selectedOptions.internetPlan && results.selectedOptions.internetPlan.price > 0 ? `${results.selectedOptions.internetPlan.name} (${results.selectedOptions.internetPlan.price.toLocaleString()}원)` : '미선택';
        selectedTvEl.textContent = results.selectedOptions.tvPackage ? results.selectedOptions.tvPackage.name : '미선택';
        selectedStbEl.textContent = results.selectedOptions.additionalStb ? results.selectedOptions.additionalStb.name : (results.selectedOptions.tvPackage ? "기본 셋톱 사용" : "미선택");
        selectedAdditionalTvEl.textContent = results.selectedOptions.additionalTv ? results.selectedOptions.additionalTv.name : '미선택';
        selectedPhoneEl.textContent = results.selectedOptions.phonePlan ? results.selectedOptions.phonePlan.name : '미선택';
        selectedWifiEl.textContent = results.selectedOptions.wifi ? results.selectedOptions.wifi.name : "미선택";
        selectedMobileCountEl.textContent = results.selectedOptions.numMobileLines;
        selectedDiscountTypeEl.textContent = results.selectedOptions.discountTypeName;

        onGajokYearsResultContainerEl.classList.toggle('hidden', results.selectedOptions.discountType !== '온가족할인');
        if (results.selectedOptions.discountType === '온가족할인') {
            const onGajokYearsOption = onGajokYearsEl.options[onGajokYearsEl.selectedIndex];
            selectedOnGajokYearsEl.textContent = onGajokYearsOption ? onGajokYearsOption.text : '';
        }

        totalBaseInternetCostEl.textContent = results.displayInternetBasePrice.toLocaleString();
        totalInternetDiscountAmountEl.textContent = results.internetDiscountAmount.toLocaleString();
        internetDiscountBreakdownEl.textContent = results.internetDiscountBreakdownText;
        
        // Card discount display
        cardDiscountSummaryContainerEl.classList.toggle('hidden', results.cardDiscount <= 0);
        if (results.cardDiscount > 0) {
            totalCardDiscountAmountEl.textContent = results.cardDiscount.toLocaleString();
            cardDiscountBreakdownEl.textContent = `(${results.selectedOptions.selectedCardName} / ${results.selectedOptions.selectedCardTierLabel} 적용)`;
        }

        wifiRouterRentalCostDisplayEl.textContent = results.wifiDisplayText;

        tvCostSummaryContainerEl.classList.toggle('hidden', !results.selectedOptions.tvPackage);
        if (results.selectedOptions.tvPackage) {
            tvBaseCostDisplayEl.textContent = results.selectedOptions.tvPackage.price.toLocaleString();
            stbRentalCostDisplayEl.textContent = results.selectedOptions.additionalStb ? results.selectedOptions.additionalStb.price.toLocaleString() : '0';
        }
        additionalTvCostSummaryContainerEl.classList.toggle('hidden', !results.selectedOptions.additionalTv);
        if (results.selectedOptions.additionalTv) {
            additionalTvCostDisplayEl.textContent = results.selectedOptions.additionalTv.price.toLocaleString();
        }
        phoneCostSummaryContainerEl.classList.toggle('hidden', !results.selectedOptions.phonePlan);
        if (results.selectedOptions.phonePlan) {
            phoneBaseCostDisplayEl.textContent = results.selectedOptions.phonePlan.price.toLocaleString();
        }

        finalMonthlyCostEl.textContent = results.finalMonthlyCost.toLocaleString();
        finalCostLabelTextEl.textContent = "최종 예상 월 납부액";
        const totalActualDiscountIfApplied = results.totalBaseSum - (results.finalMonthlyCost + results.cardDiscount) ; // Adjust base for qualifier
        if (results.selectedOptions.bundleApplicationTime === 'post' && totalActualDiscountIfApplied > 0) {
            finalCostLabelQualifierEl.textContent = ` (할인 전)`;
        } else if (totalActualDiscountIfApplied > 0 || results.cardDiscount > 0) {
            finalCostLabelQualifierEl.textContent = "(할인 적용)";
        } else {
            finalCostLabelQualifierEl.textContent = "(할인 없음)";
        }

        giftBaseInternetEl.textContent = results.baseInternetGift.toLocaleString();
        additionalDongpanCashContainerEl.classList.toggle('hidden', !results.selectedOptions.isDongpan);
        giftAdditionalDongpanCashEl.textContent = results.additionalDongpanCashSum.toLocaleString();
        giftTotalEl.textContent = results.totalGiftAmount.toLocaleString();
        giftEligibilityNoteEl.textContent = results.giftNote;

        mobileDiscountBreakdownEl.innerHTML = '';
        mobileDiscountNoteEl.textContent = '';
        if (results.perLineDiscounts.length > 0) {
            mobileDiscountDetailsContainerEl.classList.remove('hidden');
            if (results.selectedOptions.discountType === '요즘가족결합') {
                let yozoomTotalDiscount = results.perLineDiscounts.reduce((sum, item) => sum + item.bundleDiscount, 0);
                mobileDiscountNoteEl.textContent = `* '요즘가족결합'의 총 결합할인액 ${yozoomTotalDiscount.toLocaleString()}원을 ${results.perLineDiscounts.length}개의 회선에 동일하게 나누어 적용한 예상치입니다.`;
            }
            results.perLineDiscounts.forEach(item => {
                const finalMobilePrice = item.plan.price - item.discount;
                let discountDetailText = `결합 ${item.bundleDiscount.toLocaleString()}원`;
                if (item.contractDiscount > 0) {
                    discountDetailText += ` + 선택약정 ${item.contractDiscount.toLocaleString()}원`;
                }
                const p = document.createElement('p');
                p.innerHTML = `<span class="font-semibold">${item.plan.name}</span> (${item.plan.price.toLocaleString()}원) - <span class="text-green-600">휴대폰 할인 (${discountDetailText})</span> = <strong>${finalMobilePrice.toLocaleString()}원</strong> <a href="${item.plan.url}" target="_blank" class="text-sky-500 hover:text-sky-600 text-xs ml-1">(상세보기)</a>`;
                mobileDiscountBreakdownEl.appendChild(p);
            });
        } else {
            mobileDiscountDetailsContainerEl.classList.add('hidden');
        }

        installationCostResultEl.textContent = results.installationFee.toLocaleString();
        installationCostDescriptionEl.textContent = jsonData.installationFees.descriptions[results.installationFeeKey] || "";

        resultSection.classList.remove('hidden');
        messageScriptSectionEl.classList.remove('hidden');
        generateMessageScriptsSkt(results);
        // Generate new static scripts
        generateTcoScript('100M');
        generatePenaltyAnalysisScript();
        generateWaiverInfoScript();
    }

    function generateComparisonScript() {
        const isBundleType = document.querySelector('input[name="internetType"]:checked').value === 'bundle';
        
        const planId100M = isBundleType ? "internet_100m_with_tv" : "internet_100m_standalone";
        const planId500M = isBundleType ? "internet_500m_with_tv" : "internet_500m_standalone";

        if (!document.querySelector(`#internetPlan option[value="${planId100M}"]`) || !document.querySelector(`#internetPlan option[value="${planId500M}"]`)) {
            alert("비교할 100M 또는 500M 요금제를 찾을 수 없습니다. 인터넷 유형(단독/번들)을 확인해주세요.");
            return;
        }

        const results100M = calculatePlanDetails(planId100M);
        const results500M = calculatePlanDetails(planId500M);

        const wiredScript100M = generateWiredScript(results100M);
        const wiredScript500M = generateWiredScript(results500M);
        
        const monthlyCostDifference = results500M.finalMonthlyCost - results100M.finalMonthlyCost;
        const giftDifference = results500M.totalGiftAmount - results100M.totalGiftAmount;

        const comparisonScript = `[미소] 100Mbps vs 500Mbps 상품 비교 안내

고객님께서 선택하신 옵션 기준으로, 인터넷 속도만 변경했을 때의 요금과 혜택을 비교해 드립니다.

--- 100M ---
${wiredScript100M}

[최종 요금 및 혜택]
▶️ 월 ${results100M.finalMonthlyCost.toLocaleString()}원 (${results100M.selectedOptions.discountTypeName})
▶️ 사은품 ${results100M.totalGiftAmount.toLocaleString()}원

--- 500M ---
${wiredScript500M}

[최종 요금 및 혜택]
▶️ 월 ${results500M.finalMonthlyCost.toLocaleString()}원 (${results500M.selectedOptions.discountTypeName})
▶️ 사은품 ${results500M.totalGiftAmount.toLocaleString()}원
--------------------

고객님, 혹시 알고 계셨나요?
지금 선택하신 100Mbps 요금에 월 ${monthlyCostDifference > 0 ? monthlyCostDifference.toLocaleString() : 'O'}원만 추가하시면,
✅ 인터넷 속도는 5배 빨라지고,
✅ 첫 달에 받으시는 사은품은 ${giftDifference > 0 ? (giftDifference / 10000).toLocaleString() : 'O'}만원 더 커집니다!

온 가족이 동시에 접속해도 끊김 없는 500Mbps 상품으로 변경 원하시면 편하게 말씀해주세요. 😊`;

        infoScriptEl.value = comparisonScript.trim();
        alert('100M vs 500M 비교 스크립트가 생성되었습니다!');
    }

    function generateWiredScript(results) {
        let script = '[유선 상품]';
        const { internetPlan, tvPackage, additionalStb, additionalTv, phonePlan, wifi } = results.selectedOptions;
        
        script += `\n▶️ ${internetPlan.name.split(' (')[0]}`;
        
        if (tvPackage) {
            let firstTvText = tvPackage.name.split(' (')[0];
            if (additionalStb) {
                firstTvText += ` + (추가) ${additionalStb.name.split(' (')[0]}`;
            }
            script += `\n▶️ ${firstTvText}`;
        }
        if (additionalTv) script += `\n▶️ ${additionalTv.name.split(' (')[0]}`;
        if (phonePlan) script += `\n▶️ ${phonePlan.name.split(' (')[0]}`;
        if (wifi && wifi.id !== 'wifi_router_not_selected') {
            script += `\n▶️ ${wifi.name.split(' (')[0]}`;
            if (wifi.url) {
                 script += `\n   (정보: ${wifi.url})`;
            }
        }
        return script;
    }
    
    function generateMessageScriptsSkt(results) {
        // --- START: Script 2. 상품 안내 문자 (Info Script) ---
        const wiredScript = generateWiredScript(results);
        
        let finalSummaryScript = '\n\n[최종 요금 및 혜택]';
        let monthlyCostText = `▶️ 월 ${results.finalMonthlyCost.toLocaleString()}원 (${results.selectedOptions.discountTypeName})`;
        if (results.cardDiscount > 0) {
            monthlyCostText += ` + ${results.selectedOptions.selectedCardName} 할인`;
        }
        finalSummaryScript += `\n${monthlyCostText}`;
        finalSummaryScript += `\n▶️ 사은품 ${results.totalGiftAmount.toLocaleString()}원 (확정)`;

        const maxGiftAmount = results.totalGiftAmount + 70000;

        const eventScript = `\n✨참여만 해도 최대 7만원 추가 혜택이 기다려요!

🎁 최대 혜택 금액
${maxGiftAmount.toLocaleString()} 원
(확정 ${results.totalGiftAmount.toLocaleString()}원 + 참여 혜택 70,000원)

* 혜택은 실시간으로 바뀔 수 있다는 점 안내드립니다.
* 3년 약정 기준
미소 드림.

[✨추가 혜택 이벤트 상세 안내✨]
혜택 1. 생생한 후기 남기고 현금 받기! (최대 4만원)
블로그, 인스타그램 등 개인 SNS에 미소 인터넷 설치 후기를 남겨주세요.
정성스러운 후기를 작성해주신 모든 분께 현금 사은품을 드립니다!
(사진과 함께 꼼꼼한 후기를 남겨주시면 당첨 확률 UP!)

혜택 2. 좋은 건 함께! 지인 추천하고 현금 받기! (최대 3만원)
주변에 인터넷 가입을 고민하는 친구나 가족이 있다면 미소를 추천해주세요!
지인분이 고객님 추천으로 가입 및 설치를 완료하시면, 두 분 모두에게 현금 사은품을 드립니다.

▶️ 참여 방법
1. SNS에 후기를 작성하신 후, 해당 링크를 저희에게 문자로 보내주세요.
2. 지인 추천 시, 지인분께서 상담 과정에서 'OOO님 추천'이라고 꼭 말씀해주셔야 합니다.

궁금한 점은 언제든 편하게 문의해주세요.
고객님의 많은 참여를 기다리겠습니다! ❤️`;

        infoScriptEl.value = `[미소] 상품 & 사은품 요약 안내
안녕하세요, 미소 인터넷 입니다.
고객님께서 오늘 상담 받으신 상품 안내드립니다.
${wiredScript}${finalSummaryScript}
${eventScript}`;
        // --- END: Info Script ---


        // --- START: Script 1. 전산 메모 (Memo Script) ---
        const { internetPlan, tvPackage, additionalStb, additionalTv, phonePlan, wifi, bundleApplicationTime, discountType, discountTypeName, isDongpan, onGajokYearsKey, numMobileLines, selectedCardName } = results.selectedOptions;
        const monthlyFeeTextForMemo = `월 ${results.totalBaseSum.toLocaleString()}원(할인전)${bundleApplicationTime === 'pre' && (results.totalBaseSum - (results.finalMonthlyCost + results.cardDiscount) > 0) ? ` / 월 ${(results.finalMonthlyCost + results.cardDiscount).toLocaleString()}원(결합할인적용)`: ''}${results.cardDiscount > 0 ? ` / 월 ${results.finalMonthlyCost.toLocaleString()}원(카드할인 최종)` : ''}`;
        
        let giftBreakdown = `기본 ${results.baseInternetGift.toLocaleString()}원`;
        if(isDongpan && results.additionalDongpanCashSum > 0) {
            giftBreakdown += ` + 동판추가(모바일연동) ${results.additionalDongpanCashSum.toLocaleString()}원`;
        }

        let productDescriptionMemo = internetPlan.name.split(' (')[0];
        if (wifi && wifi.id !== 'wifi_router_not_selected') {
            productDescriptionMemo += ` + ${wifi.name.split(' (')[0]}`;
        }
        if (tvPackage) {
            let tvBaseName = tvPackage.name.split(' (')[0];
            let stbName = additionalStb ? additionalStb.name.split(' (')[0] : (tvPackage.stb || (tvPackage.name.includes("스마트3") ? "스마트3" : ""));
            productDescriptionMemo += ` + ${tvBaseName}`;
            if (stbName) productDescriptionMemo += ` + ${stbName}`;
        }
        if (additionalTv) productDescriptionMemo += ` + (추가TV) ${additionalTv.name.split(' (')[0]}`;
        if (phonePlan) productDescriptionMemo += ` + ${phonePlan.name.split(' (')[0]}`;
        
        let bundleTypeText = "";
        if (discountType === '요즘가족결합') bundleTypeText = '요가';
        else if (discountType === '온가족할인') bundleTypeText = '온할';

        let mobilePlansText = "해당 없음";
        if (numMobileLines > 0 && results.perLineDiscounts.length > 0) {
            mobilePlansText = results.perLineDiscounts.map(item => item.plan.name).join(', ');
        }

        const baekmegaMemo = `\n\n<백메가 기타 메모 양식>
    고객명 :
    동판유선명의자 :
    연락처 :
    기존통신사 :
    유심발송주소 :
    선택약정여부 (12개월/24개월) :
    요금제 : ${mobilePlansText}
    유심비 후청구 동의 (Y/N) : Y
    ★ 결합여부 (요가/온할) : ${bundleTypeText}
    ★ 할인지정(대표자할인or분할할인) : 분할할인
    ★ 패스or신용카드 인증 : 패스인증`;

        const requiredGuidanceMemo = `\n\n<고객 상황에따른 필수안내사항 완료>
    1.  기존 가족 또는 본인 명의 회선 있는 경우 유지 필요 안내 완료
    2. 이사 고객 Y / 추후 소명 발생 시 관련 서류 제출 동의 수긍
    3. 인터넷 설치 후 고객센터로 후결합 요청 안내 완료`;

        memoScriptEl.value = `[SKB/SKT 미소 상담 메모]
    1. 상품 : ${productDescriptionMemo}
    2. 요금 : ${monthlyFeeTextForMemo}
    3. 사은품 총액 : ${results.totalGiftAmount.toLocaleString()}원 (${giftBreakdown}) (예상)
    4. 설치비 : ${results.installationFee.toLocaleString()}원
    5. 결합적용시점: ${bundleApplicationTime === 'pre' ? '선결합' : '후결합'}
    6. 기타 : 이사 여부 [ ] / 희망설치일자 [    년  월  일]
    7. 할인유형: ${discountTypeName}
    ${onGajokYearsResultContainerEl.classList.contains('hidden') ? '' : `8. 온가족총연수: ${onGajokYearsEl.options[onGajokYearsEl.selectedIndex].text}`}
    9. 모바일결합회선: ${numMobileLines}개
    10. 동판판매가적용: ${isDongpan ? 'Y' : 'N'}
    11. 제휴카드: ${selectedCardName ? selectedCardName : '미적용'}` + (isDongpan ? baekmegaMemo : '') + requiredGuidanceMemo;
        // --- END: Memo Script ---


        // --- START: Script 3. 가입 완료 문자 (Complete Script) ---
        let productDescriptionComplete = `▶️ ${internetPlan.name.split(' (')[0]}`;
        if (wifi && wifi.id !== 'wifi_router_not_selected') productDescriptionComplete += `\n▶️ ${wifi.name.split(' (')[0]}`;
        if (tvPackage) {
             let firstTvText = tvPackage.name.split(' (')[0];
             if (additionalStb) firstTvText += ` + (추가) ${additionalStb.name.split(' (')[0]}`;
             productDescriptionComplete += `\n▶️ ${firstTvText}`;
        }
        if (additionalTv) productDescriptionComplete += `\n▶️ ${additionalTv.name.split(' (')[0]}`;
        if (phonePlan) productDescriptionComplete += `\n▶️ ${phonePlan.name.split(' (')[0]}`;

        let descriptiveMonthlyFeeText = `월 ${results.finalMonthlyCost.toLocaleString()}원 (${discountTypeName}${selectedCardName ? ` + ${selectedCardName} 할인` : ''})`;

        let postInstallActionScript = '';
        if(results.selectedOptions.discountType !== 'noBundleDiscount') {
            postInstallActionScript = `\n
⚠️ [필독] 월 요금 할인을 위한 마지막 단계!

고객님, 설치 후 30일 이내에 직접 결합 신청을 완료하셔야 매달 요금 할인이 적용됩니다.
아래 번호로 전화하셔서 "인터넷이랑 휴대폰(또는 TV) 결합 신청합니다"라고 말씀해주세요!
(기한이 지나 할인을 놓치시는 일이 없도록 지금 바로 신청하시는 것을 권해드립니다.)

■ SK 고객님 : 핸드폰에서 114번으로 전화`;
        }

        completeScriptEl.value = `[SKB/SKT 미소] 가입 완료 안내
    안녕하세요, 고객님. 미소 SK브로드밴드/SK텔레콤 부서입니다.
    ✅ 계약이 완료되었어요, 아래 내용은 계약서와 동일한 효력이 있으니 꼼꼼히 읽어주세요.
    ⚠️ 3년 약정이며, 아래와 같은 상황에 해당하면 받으셨던 사은품은 환수될 수 있습니다:
    ① 1년 이내 해지 ② 3개월(90일) 이상 정지 ③ 1년 이내 요금제 하향 ④ 3개월 이내 명의변경 ⑤ 개통 1개월 이내 결제수단 지로 변경
    ⚠️ 신규 가입 후 기존 인터넷은 꼭 직접 해지해주세요. 자동해지되지 않아 요금이 이중 부과될 수 있습니다.
    ⚠️ 3년 이내 해지 시 통신사 본사에 위약금(할인 반환금) 및 면제된 장비 임대료/설치비 등이 부과될 수 있습니다.
    ✅ 가입 상품 안내
    ${productDescriptionComplete}
    ▶️ ${descriptiveMonthlyFeeText}
    ▶️ 설치비 ${results.installationFee.toLocaleString()}원 첫 달 부과
    ▶️ 총 사은품 ${results.totalGiftAmount.toLocaleString()}원 (${giftBreakdown}) (예상)
    ✅사은품은 설치 후 7일 이내 자동으로 지급되나 평일기준 5시 이전 개통 받았다고 문자 주시면 당일입금 도움드리겠습니다.${postInstallActionScript}
    🔊 해당 연락처로 연락이 어려울 경우 걱정하지 마세요! 아래 대표번호로 문의주시면 확인하여 연락드리겠습니다.
    [미소를 소개해주세요]
    지인이 미소에서 인터넷/TV 설치하면 소개해주신 분에게 현금 혜택을 드려요! (자세한 내용은 문의)
    미소 드림.`;
        // --- END: Complete Script ---

        
        // --- Other Scripts (Unchanged from previous logic) ---
        if (usimDongpanCompleteScriptEl) {
            usimDongpanCompleteScriptEl.value = `[미소] 유심 접수 완료 안내
    안녕하세요, 고객님.
    미소 인터넷 부서입니다.
    ✅ 유심동판 접수가 완료되었어요, 아래 내용은 계약서와 동일한 효력이 있으니 꼼꼼히 읽어주세요.⚠️ 12개월/24개월 약정이며, 아래와 같은 상황에 해당하면 받으셨던 사은품은 환수 됩니다.① 183일 이내 해지 및 요금제 하향
    ② 개통 후 무통화 대상
    ③ 183일 이내 명의변경 통신사 변경 시④ 183일 이내 결합 해지
    ⑤ 인터넷 개통 후 익월 말일까지 꼭 유심 개통이 필요해요!
    ⚠️ 유심 개통 완료 되면 사용하셨던 유심과 교체하여 기기 전원을 3~4회 껏다 키시면 됩니다!✅사은품은 설치 후 7일 이내 자동으로 지급되나 평일기준 5시 이전 개통 받았다고 문자 주시면 당일입금 도움드리겠습니다.🔊 해당 연락처로 연락이 어려울 경우 걱정하지 마세요! 아래 대표번호로 문의주시면 확인하여 연락드리겠습니다. 시간 양해 부탁드려요.[미소를 소개해주세요]
    지인이 미소에서 인터넷 설치하면 소개해주신 분에게 3만원 드려요.▶ 지인에게 추천하고 3O,OOO원 받기 (↓)
    https://get.miso.kr/pZbfsUPthzb
    미소 드림.☎ 미소 대표번호 1577-8808 오전 9시 ~ 오후 10시 (연중무휴)`;
        }
    
        if (sensitiveInfoLinkScriptEl) {
            sensitiveInfoLinkScriptEl.value = `[SK] 아래 링크에 고객님의 민감정보를 입력하시면 SK로 고객님의 민감정보가 직접 전송후 접수 됩니다.
입력후 접수 완료 라고 문자 주시면 담당 상담원이 접수 확인후 필수 안내사항 안내 드리겠습니다.
https://miso.kr/booking/forms/secure-details?querystring=고객님 전화번호`;
        }
    }
    
    // --- NEW STATIC SCRIPT GENERATORS ---
    function generateTcoScript(speed) {
        let scriptContent = '';
        if (speed === '100M') {
            scriptContent = `[미소] 3년 약정, 1년만 써도 이득인 이유 (100Mbps 기준)

고객님, 약정 기간 때문에 고민하시는 마음 충분히 이해합니다.
그래서 100Mbps 인터넷 기준으로, 1년 약정과 3년 약정의 실제 총비용(TCO)을 꼼꼼하게 비교해 드렸습니다.

결론부터 말씀드리면, 3년 약정은 1년(13개월)만 사용하고 해지해도 1년 약정보다 **9만원 이상 저렴합니다.**

[인터넷 단독 (100Mbps) 총비용 비교]
--------------------------------
🆚 1년 약정
- 월 요금: 31,900원
- 13개월 총비용: 약 414,700원

✅ 3년 약정 (13개월 사용 후 해지 시)
- 월 요금: 22,000원 (사은품 11만원 포함)
- 13개월 총비용: 약 315,600원 (👉 9만원 이상 이득!)
--------------------------------

✨ 가장 중요한 포인트!
3년 약정은 시간이 지날수록 위약금이 크게 줄어듭니다. 예상보다 오래 사용하실수록 3년 약정이 압도적으로 유리합니다.

※ TCO(총 소유 비용)란? 월 요금, 사은품 혜택, 중도 해지 시 위약금까지 모두 계산했을 때, 고객님께서 실제로 부담하시는 총 금액입니다.
※ 출처: T월드>유의사항>할인반환금 부과기준`;
        } else if (speed === '500M') {
            scriptContent = `[미소] 3년 약정, 1년만 써도 이득인 이유 (500Mbps 기준)

고객님, 약정 기간 때문에 고민하시는 마음 충분히 이해합니다.
그래서 500Mbps 인터넷 기준으로, 1년 약정과 3년 약정의 실제 총비용(TCO)을 꼼꼼하게 비교해 드렸습니다.

결론부터 말씀드리면, 3년 약정은 1년(13개월)만 사용하고 해지해도 1년 약정보다 **20만원 이상 저렴합니다.**

[인터넷 단독 (500Mbps) 총비용 비교]
--------------------------------
🆚 1년 약정
- 월 요금: 44,000원
- 13개월 총비용: 약 572,000원

✅ 3년 약정 (13개월 사용 후 해지 시)
- 월 요금: 33,000원 (사은품 17만원 포함)
- 13개월 총비용: 약 370,005원 (👉 20만원 이상 이득!)
--------------------------------

✨ 가장 중요한 포인트!
3년 약정은 시간이 지날수록 위약금이 크게 줄어듭니다. 예상보다 오래 사용하실수록 3년 약정이 압도적으로 유리합니다.

※ TCO(총 소유 비용)란? 월 요금, 사은품 혜택, 중도 해지 시 위약금까지 모두 계산했을 때, 고객님께서 실제로 부담하시는 총 금액입니다.
※ 출처: T월드>유의사항>할인반환금 부과기준`;
        }
        tcoComparisonResultScriptEl.value = scriptContent;
    }

    function generatePenaltyAnalysisScript() {
        penaltyAnalysisScriptEl.value = `[미소] SK브로드밴드 위약금, 정확히 알려드립니다.

**1. SKB의 위약금 공식**
SKB는 아래 공식에 따라 위약금을 산정합니다. (23년 9월 27일 이후 가입자 기준)
▶ 위약금 = (총 할인받은 금액) x (감면율)
- 총 할인액: (정상가-약정가) x 이용 개월 수
- 감면율: {잔여 약정일수 / (총 약정일수 - 240일)}

**2. 꼭 아셔야 할 핵심 포인트 1: '8개월'의 비밀**
SKB 약관상, 가입 후 첫 8개월 동안은 위약금 감면이 적용되지 않습니다. 이 기간에는 할인받은 금액이 그대로 위약금으로 누적되어, 초반 해지 시 부담이 가장 큽니다.

**3. 꼭 아셔야 할 핵심 포인트 2: '9개월' 이후의 변화**
9개월 차부터는 위약금 감면이 시작되어, 시간이 지날수록 위약금이 계속해서 감소하는 구조입니다.

(예시: 100M 인터넷, 매달 14,300원 할인 시)
- 8개월 차 위약금: 114,400원 (할인액 전액)
- 13개월 차 위약금: 약 152,046원
- 18개월 차 위약금: 약 164,964원
- 24개월 차 위약금: 약 146,187원 (다시 감소 시작)

**4. 결론: 가장 합리적인 선택과 '안전장치'**
이러한 구조 때문에, 1년 이상 사용하실 계획이라면 앞서 보내드린 'TCO 비교' 자료에서 보셨듯 3년 약정이 압도적으로 유리합니다.

또한, 이사 시 설치 불가 등 약관에 명시된 정당한 사유가 발생하면 위약금 없이 해지가 가능한 '위약금 면제'라는 안전장치도 마련되어 있으니 안심하셔도 좋습니다.

※ 출처: T월드>유의사항>할인반환금 부과기준`;
    }

    function generateWaiverInfoScript() {
        waiverInfoScriptEl.value = `[미소] 고객님의 권리, '위약금 면제 조건' 상세 안내

안녕하세요, 고객님.
3년 약정 기간 중 예기치 못한 상황이 발생할까 걱정되실 수 있습니다.
고객님의 알 권리를 위해, 약관에 명시된 '위약금 면제(합법적 해지)' 조건들을 투명하게 안내해 드립니다.

아래 조건에 해당될 경우, 위약금 없이 계약을 해지하실 수 있습니다.

**1. 서비스 품질이 기준에 미달하는 경우**
- 인터넷 속도가 '최저보장속도(SLA)' 기준에 지속적으로 미달 (월 5회 이상 측정 기록 필요)
- 서비스 장애로 A/S를 월 3회 이상 받았으나 개선되지 않을 경우
- 월 누적 장애 시간이 통신사 기준(SKB 24시간)을 초과한 경우

**2. 이사 등으로 서비스 이용이 불가능한 경우**
- 이사한 장소가 통신사의 서비스 제공 불가 지역인 경우 (가장 일반적인 면제 사유)
- 이사한 건물이 특정 통신사와 독점 계약 상태라 타사 인터넷 설치가 불가능한 경우

**3. 가입자 개인의 피치 못할 사정이 생긴 경우**
- 계약자 본인이 군에 입대하는 경우 (입영통지서 등 증빙 서류 필요)
- 계약자가 사망한 경우

이처럼 고객님을 보호하기 위한 여러 '안전장치'가 마련되어 있습니다.
이러한 조건들을 확인하시고, 가장 경제적인 3년 약정을 안심하고 선택하시길 바랍니다.

※ 출처: 통신사 이용약관 및 방송통신위원회 관련 규정`;
    }
    
    function copyToClipboard(elementId, feedbackElementId) {
        const textarea = document.getElementById(elementId);
        textarea.select();
        textarea.setSelectionRange(0, 99999); 
        try {
            document.execCommand('copy');
            const feedbackEl = document.getElementById(feedbackElementId);
            feedbackEl.textContent = '복사되었습니다!';
            setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
        } catch (err) {
            const feedbackEl = document.getElementById(feedbackElementId);
            feedbackEl.textContent = '복사 실패';
            setTimeout(() => { feedbackEl.textContent = ''; }, 2000);
        }
        window.getSelection().removeAllRanges(); 
    }
    
    // --- AI 스크립트 생성 함수 ---
    async function generateAIPersuasionScript() {
        const consultationText = aiConsultationInputEl.value;
        if (!consultationText.trim()) {
            aiResultScriptEl.value = "고객 상담 내용을 먼저 입력해주세요.";
            return;
        }
    
        aiLoadingIndicatorEl.classList.remove('hidden');
        generateAiScriptButtonEl.disabled = true;
        aiResultScriptEl.value = "";
    
        const apiKey = "AIzaSyDyhCvqgf6HW32Dj0BBBanwijfvtee9P4s"; // API 키는 그대로 유지합니다.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;
    
        // ======================= ⬇️ 여기부터 변경 ⬇️ =======================
    
        // 1. 새로 추가된 'AI 고급 설정' UI에서 값들을 가져옵니다.
        const role = document.getElementById('aiRoleInput').value || "베테랑 통신 상담원";
        const tone = document.getElementById('aiToneSelect').value || "전문적이고 신뢰감 있는";
        const audience = document.getElementById('aiAudienceInput').value || "인터넷 가입을 고민하는 고객";
        const emotion = document.getElementById('aiEmotionInput').value || "더 나은 통신 서비스에 대한 기대감";
        const structure = document.getElementById('aiStructureSelect').value || "공감 -> 핵심 혜택 강조 -> 결정 촉구";
    
        // 2. 마스터 프롬프트를 기반으로 최종 프롬프트를 동적으로 조립합니다.
        const prompt = `
    ### 지시 시작 ###
    1. 페르소나 및 에토스 설정:
    - 역할: 당신은 [ ${role} ]로서 행동합니다.
    - 핵심 신념: 당신은 '고객에게 딱 맞는 통신 서비스를 찾아주는 것이 나의 가장 중요한 임무'라는 것을 진심으로 믿습니다.
    - 어조: [ ${tone} ] 어조를 유지하세요. 독자를 가르치려 들기보다는, 중요한 통찰을 공유하는 전문가의 입장을 취하세요.
    
    2. 청중 및 파토스 조정:
    - 대상 독자: 이 글은 [ ${audience} ]을 대상으로 합니다.
    - 감정적 연결: 독자의 [ ${emotion} ]에 호소하세요.
    - 스토리텔링 기법: 글의 서두에 고객의 상황에 공감하는 짧고 진솔한 문장으로 즉각적인 공감대를 형성하세요.
    
    3. 논리적 프레임워크 및 로고스 구조:
    - 논증 구조: 글을 [ ${structure} ] 구조로 조직하세요.
    - 핵심 주장: 서론에서 이 제안이 고객에게 왜 최선인지를 명확하게 제시하세요.
    
    4. 문체 및 작법 지시:
    - '보여주기' 기법: "인터넷이 빨라집니다" 대신 "온 가족이 동시에 넷플릭스를 봐도 끊김 없는 환경을 상상해보세요" 처럼 구체적으로 보여주세요.
    - 수사법 활용: 강력한 은유나 직유를 1개 이상 사용하고, 고객의 고민을 짚어주는 수사적 질문을 활용하세요.
    - 문장 다양성: 짧고 간결한 문장과 리듬감 있는 문장을 혼합하여 사용하세요.
    
    5. 과업 실행 및 출력 형식:
    - 구체적 과업: 아래 [상담 내용]을 바탕으로, '생각해볼게요'라고 말하는 고객을 설득하여 가입을 유치하기 위한 진심과 필력이 담긴 문자 메시지 초안을 작성하세요.
    - 분량: 전체 글의 길이는 약 3~4 문단으로 제한합니다.
    - 형식: 제목 없이 바로 시작하는 문자 메시지 형식으로 작성하세요. 이모티콘(😊, ✅, 👍)을 1~3개 적절히 사용하여 친근함을 더하세요.
    - ======================= ⬇️ 여기부터 추가된 규칙 ⬇️ =======================
    - **매우 중요**: 메시지는 반드시 아래의 두 줄로 정확히 시작해야 합니다. 다른    인사말로 시작해서는 절대 안 됩니다.
    안녕하세요 고객님 !!
    미소인터넷 가입부서 김홍식 팀장입니다
    - **주의사항**: '아까', '오늘 오전에', '어제 상담드렸던' 등 상담 시점을 유추할 수 있는 시간 관련 표현은 절대 사용하지 마세요. 메시지는 언제 보내도 어색하지 않아야 합니다.
    - ======================= ⬆️ 여기까지 추가된 규칙 ⬆️ =======================
    ### 지시 종료 ###
    
    ---
    [상담 내용]
    ${consultationText}
    ---
    `;
        // ======================= ⬆️ 여기까지 변경 ⬆️ =======================
    
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                }),
            });
    
            if (!response.ok) {
                const errorBody = await response.json();
                console.error("API Error Response:", errorBody);
                throw new Error(`API 요청 실패: ${response.status} ${response.statusText}`);
            }
    
            const result = await response.json();
            const candidate = result.candidates?.[0];
    
            if (candidate && candidate.content?.parts?.[0]?.text) {
                aiResultScriptEl.value = candidate.content.parts[0].text;
            } else {
                aiResultScriptEl.value = "오류: AI로부터 유효한 응답을 받지 못했습니다. 잠시 후 다시 시도해주세요.";
                console.error("Unexpected API response structure:", result);
            }
    
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            aiResultScriptEl.value = `오류가 발생했습니다: ${error.message}. 잠시 후 다시 시도해주세요.`;
        } finally {
            aiLoadingIndicatorEl.classList.add('hidden');
            generateAiScriptButtonEl.disabled = false;
        }
    }


    // Initialize
    function setInitialDefaults() {
        initializeSelects(); 
    
        const noBundleDiscountRadio = document.querySelector('input[name="discountType"][value="noBundleDiscount"]');
        if (noBundleDiscountRadio) {
            noBundleDiscountRadio.checked = true;
            const discountChangeEvent = new Event('change', { bubbles: true });
            noBundleDiscountRadio.dispatchEvent(discountChangeEvent);
        }
        
        const internetTypeStandaloneRadio = document.querySelector('input[name="internetType"][value="standalone"]');
        if (internetTypeStandaloneRadio) { 
            internetTypeStandaloneRadio.checked = true;
        }
        populateInternetPlansDropdown(); 
        
        const firstStandaloneInternet = jsonData.internetPlans_base[0]?.id;
         if (internetPlanEl.querySelector(`option[value="${firstStandaloneInternet}"]`)) {
             internetPlanEl.value = firstStandaloneInternet;
        } else if (jsonData.internetPlans_base.length > 0) { 
             internetPlanEl.value = jsonData.internetPlans_base[0].id;
        } else {
             internetPlanEl.value = 'none';
        }
        const internetPlanChangeEvent = new Event('change'); 
        internetPlanEl.dispatchEvent(internetPlanChangeEvent); 
    
    
        tvPlanEl.value = 'none'; 
        wifiRouterEl.value = "wifi_router_default"; 
        tvStbEl.value = 'none'; 
        additionalTvPlanEl.value = 'none';
        phonePlanEl.value = 'none';
        
        dongpanSalesCheckEl.checked = false;
        affiliateCardSelectEl.value = 'none';
        handleCardChange();
    
        const weekdayInstallRadio = document.querySelector('input[name="installationTime"][value="weekday"]');
        if(weekdayInstallRadio) weekdayInstallRadio.checked = true;
    
        updateTvSubOptionsState();
        manageWifiSelection();
    
        allDetailSectionsSkt.forEach(section => {
            let isVisible = false; 
            if (section.containerEl) {
                const isSelected = document.querySelector(`input[name="discountType"][value="${section.radioValue}"]`).checked;
                if (isSelected) { 
                    if (section.toggleEl) isVisible = section.toggleEl.checked;
                } else { 
                    if (section.toggleEl) section.toggleEl.checked = false;
                }
                section.containerEl.classList.toggle('hidden', !isVisible);
                if (isVisible && section.updateFn) section.updateFn();
            }
        });
        
        onGajokYearsGroupEl.classList.toggle('hidden', document.querySelector('input[name="discountType"]:checked').value !== '온가족할인');
        internetUsageYearsGroupEl.classList.toggle('hidden', document.querySelector('input[name="discountType"]:checked').value !== '온가족할인');
        dongpanUsimPolicyDetailsContainerEl.classList.toggle('hidden', !dongpanSalesCheckEl.checked);
        
        resultSection.classList.add('hidden');
        messageScriptSectionEl.classList.add('hidden');
    
        detailsContainerEl.classList.add('hidden');
        toggleDetailsButtonEl.innerHTML = '상세 요금 내역 펼쳐보기 ▼';
    
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    window.onload = setInitialDefaults;
    </script>
</body>
</html>
